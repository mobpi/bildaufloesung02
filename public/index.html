<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digitalisierung von Bilddaten & Audiodaten - Speicherbedarf | GINF Lernkurs</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #10b981;
            --accent: #f59e0b;
            --danger: #ef4444;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-light: #334155;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --success: #22c55e;
            --purple: #a855f7;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            position: sticky;
            top: 0;
            z-index: 100;
            flex-wrap: wrap;
            gap: 10px;
        }

        /* NEW: Mobile Sidebar Toggle */
        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .sidebar-toggle-btn {
            display: none; /* Hide on desktop */
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s;
        }

        .sidebar-toggle-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .logo {
            font-size: 1.4em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .student-info {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.1);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
        }
        
        .points-display {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid var(--secondary);
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            color: var(--secondary);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .points-display:hover {
            background: rgba(16, 185, 129, 0.3);
        }
        
        .progress-container {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        
        .progress-bar {
            width: 200px;
            height: 10px;
            background: rgba(255,255,255,0.2);
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--secondary);
            transition: width 0.5s ease;
        }
        
        .progress-text {
            font-size: 0.85em;
            margin-top: 3px;
        }
        
        .main-container {
            display: flex;
            min-height: calc(100vh - 70px);
        }
        
        .sidebar {
            width: 280px;
            background: var(--bg-card);
            padding: 20px;
            border-right: 1px solid var(--bg-light);
            overflow-y: auto;
            flex-shrink: 0;
            position: fixed;
            top: 70px;
            left: 0;
            height: calc(100vh - 70px);
            z-index: 90;
            transition: transform 0.3s ease-in-out;
        }
        
        .sidebar-spacer {
            width: 280px;
            flex-shrink: 0;
        }
        
        .sidebar h3 {
            color: var(--text-muted);
            font-size: 0.8em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
        }
        
        .module-list {
            list-style: none;
        }
        
        .module-item {
            margin-bottom: 8px;
        }
        
        .module-btn {
            width: 100%;
            padding: 12px 15px;
            background: transparent;
            border: 1px solid var(--bg-light);
            border-radius: 8px;
            color: var(--text);
            text-align: left;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95em;
        }
        
        .module-btn:hover {
            background: var(--bg-light);
            border-color: var(--primary);
        }
        
        .module-btn.active {
            background: var(--primary);
            border-color: var(--primary);
        }
        
        .module-btn.completed {
            border-color: var(--secondary);
        }
        
        .module-btn.completed::after {
            content: '‚úì';
            margin-left: auto;
            color: var(--secondary);
        }
        
        .module-score {
            margin-left: auto;
            font-size: 0.8em;
            padding: 2px 8px;
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
        }
        
        .module-score.passed { background: rgba(16, 185, 129, 0.3); color: var(--secondary); }
        .module-score.failed { background: rgba(239, 68, 68, 0.3); color: var(--danger); }
        
        .content {
            flex: 1;
            padding: 30px;
            padding-top: 100px; /* Platz f√ºr fixed calculator */
            overflow-y: auto;
            max-width: 1100px;
            margin-left: 280px; /* Platz f√ºr fixed sidebar */
        }
        
        .screen { display: none; }
        .screen.active { display: block; }
        
        .welcome-hero {
            text-align: center;
            padding: 60px 20px;
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-light) 100%);
            border-radius: 20px;
            margin-bottom: 40px;
        }
        
        .welcome-hero h1 {
            font-size: 2.5em;
            margin-bottom: 15px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .welcome-hero p {
            color: var(--text-muted);
            font-size: 1.2em;
            max-width: 600px;
            margin: 0 auto 30px;
        }
        
        .name-input-container {
            text-align: center;
            padding: 60px 20px;
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-light) 100%);
            border-radius: 20px;
            max-width: 500px;
            margin: 50px auto;
        }
        
        .name-input-container h2 {
            margin-bottom: 20px;
            color: var(--primary);
        }
        
        .name-input {
            width: 100%;
            max-width: 300px;
            padding: 15px 20px;
            font-size: 1.1em;
            border: 2px solid var(--bg-light);
            border-radius: 10px;
            background: var(--bg-dark);
            color: var(--text);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .name-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: var(--secondary);
            color: white;
        }
        
        .btn-success:hover {
            background: #0ea572;
        }
        
        .start-btn {
            padding: 15px 40px;
            font-size: 1.1em;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border: none;
            border-radius: 30px;
            color: white;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .start-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.4);
        }
        
        .section {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--bg-light);
        }
        
        .section h2 {
            font-size: 1.3em;
            margin-bottom: 15px;
            color: var(--accent);
        }
        
        .section p {
            margin-bottom: 15px;
        }
        
        .theory-box {
            background: rgba(99, 102, 241, 0.1);
            border-left: 4px solid var(--primary);
            padding: 15px 20px;
            margin: 15px 0;
            border-radius: 0 10px 10px 0;
        }
        
        .theory-box h4 {
            color: var(--primary);
            margin-bottom: 8px;
        }
        
        .formula-box {
            background: var(--bg-dark);
            padding: 15px 25px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 1.1em;
            color: var(--accent);
            text-align: center;
            margin: 15px 0;
            border: 1px solid var(--bg-light);
        }
        
        .tip-box {
            background: rgba(16, 185, 129, 0.1);
            border-left: 4px solid var(--secondary);
            padding: 15px 20px;
            margin: 15px 0;
            border-radius: 0 10px 10px 0;
        }
        
        .warning-box {
            background: rgba(245, 158, 11, 0.1);
            border-left: 4px solid var(--accent);
            padding: 15px 20px;
            margin: 15px 0;
            border-radius: 0 10px 10px 0;
        }
        
        /* Formelsammlung Table */
        .formula-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: var(--bg-dark);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .formula-table th, .formula-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--bg-light);
        }
        
        .formula-table th {
            background: var(--primary);
            color: white;
            font-weight: bold;
        }
        
        .formula-table tr:hover {
            background: rgba(255,255,255,0.05);
        }
        
        .formula-table code {
            background: rgba(0,0,0,0.3);
            padding: 2px 8px;
            border-radius: 4px;
            font-family: monospace;
            color: var(--accent);
        }
        
        /* Calculator Styles */
        .calculator-container {
            background: var(--bg-dark);
            border: 2px solid var(--purple);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .calculator-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            color: var(--purple);
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .calc-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .calc-input {
            padding: 10px 15px;
            font-size: 1em;
            background: var(--bg-card);
            border: 2px solid var(--bg-light);
            border-radius: 8px;
            color: var(--text);
            width: 120px;
            text-align: center;
        }
        
        .calc-input:focus {
            outline: none;
            border-color: var(--purple);
        }
        
        .calc-label {
            color: var(--text-muted);
            min-width: 80px;
        }
        
        .calc-btn {
            padding: 10px 20px;
            background: var(--purple);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .calc-btn:hover {
            background: #9333ea;
            transform: translateY(-2px);
        }
        
        .calc-steps {
            background: rgba(168, 85, 247, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.95em;
            display: none;
        }
        
        .calc-steps.show {
            display: block;
        }
        
        .calc-step {
            margin-bottom: 8px;
            padding: 5px 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 5px;
        }
        
        .calc-result {
            color: var(--secondary);
            font-weight: bold;
            font-size: 1.2em;
            margin-top: 10px;
            padding: 10px;
            background: rgba(16, 185, 129, 0.2);
            border-radius: 8px;
        }
        
        /* Exercise Styles */
        .exercise-container {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border: 2px solid var(--bg-light);
        }
        
        .exercise-container.correct {
            border-color: var(--secondary);
            background: rgba(16, 185, 129, 0.05);
        }
        
        .exercise-container.incorrect {
            border-color: var(--danger);
            background: rgba(239, 68, 68, 0.05);
        }
        
        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .exercise-number {
            background: var(--primary);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
        }
        
        .exercise-points {
            background: rgba(245, 158, 11, 0.2);
            color: var(--accent);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
        }
        
        .exercise-question {
            font-size: 1.1em;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        
        .answer-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        
        .answer-input {
            padding: 12px 20px;
            font-size: 1.1em;
            background: var(--bg-dark);
            border: 2px solid var(--bg-light);
            border-radius: 10px;
            color: var(--text);
            width: 150px;
            text-align: center;
        }
        
        .answer-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .answer-input.correct {
            border-color: var(--secondary);
            background: rgba(16, 185, 129, 0.1);
        }
        
        .answer-input.incorrect {
            border-color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
        }
        
        .answer-unit {
            color: var(--text-muted);
            font-weight: bold;
        }
        
        .check-btn {
            padding: 12px 25px;
            background: var(--secondary);
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .check-btn:hover {
            background: #0ea572;
        }
        
        .check-btn:disabled {
            background: var(--bg-light);
            cursor: not-allowed;
        }
        
        .feedback {
            margin-top: 15px;
            padding: 15px;
            border-radius: 10px;
            display: none;
        }
        
        .feedback.show {
            display: block;
        }
        
        .feedback.correct {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--secondary);
            color: var(--secondary);
        }
        
        .feedback.incorrect {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
        }

        /* NEW: Solution Toggle for Correct Answers */
        .solution-toggle {
            cursor: pointer;
            color: var(--primary);
            font-weight: bold;
            display: inline-block;
            margin-top: 10px;
        }

        .solution-details {
            display: none;
            margin-top: 10px;
        }
        
        /* Simulation Styles */
        .simulator {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
        }
        
        .sim-header {
            color: var(--secondary);
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        
        .sim-content {
            display: flex;
            gap: 30px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .input-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .input-row {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .input-label {
            font-weight: bold;
            width: 140px;
            color: var(--text-muted);
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .slider {
            width: 150px;
            height: 8px;
            -webkit-appearance: none;
            background: var(--bg-light);
            border-radius: 4px;
            outline: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
        }
        
        .slider-value {
            min-width: 90px;
            padding: 5px 10px;
            background: var(--bg-dark);
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            color: var(--accent);
        }

        /* NEW: Audio Quantization Steps Display */
        .quantization-steps {
            margin-top: 15px;
            text-align: center;
            font-size: 0.9em;
            color: var(--text-muted);
        }
        
        .output-display {
            text-align: center;
            padding: 20px;
            background: var(--bg-dark);
            border-radius: 10px;
            min-width: 180px;
        }
        
        .output-value {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--secondary);
        }
        
        .output-label {
            font-size: 0.85em;
            color: var(--text-muted);
            margin-top: 5px;
        }
        
        /* Results Summary */
        .results-summary {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 40px;
            margin: 30px 0;
            text-align: center;
        }
        
        .results-summary h2 {
            color: var(--primary);
            margin-bottom: 30px;
            font-size: 1.8em;
        }
        
        .results-stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .stat-box {
            text-align: center;
            padding: 20px 30px;
            background: var(--bg-dark);
            border-radius: 15px;
            min-width: 150px;
        }
        
        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
        }
        
        .stat-value.excellent { color: var(--secondary); }
        .stat-value.good { color: var(--accent); }
        .stat-value.needs-work { color: var(--danger); }
        
        .stat-label {
            color: var(--text-muted);
            margin-top: 5px;
        }
        
        .errors-list {
            background: var(--bg-dark);
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            text-align: left;
        }
        
        .errors-list h3 {
            color: var(--danger);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .error-item {
            background: rgba(239, 68, 68, 0.1);
            border-left: 4px solid var(--danger);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 0 10px 10px 0;
        }
        
        .error-question {
            color: var(--text);
            margin-bottom: 10px;
        }
        
        .error-details {
            display: flex;
            gap: 20px;
            font-size: 0.95em;
        }
        
        .error-given {
            color: var(--danger);
        }
        
        .error-correct {
            color: var(--secondary);
        }
        
        /* Pixel Preview */
        .pixel-preview {
            display: grid;
            gap: 2px;
            background: var(--bg-light);
            padding: 2px;
            border-radius: 5px;
            width: fit-content;
            margin: 15px auto;
        }
        
        .pixel {
            width: 15px;
            height: 15px;
            background: var(--primary);
            transition: all 0.3s;
        }
        
        /* Navigation Buttons */
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        /* Responsive */
        @media (max-width: 900px) {
            .sidebar {
                position: fixed;
                width: 280px;
                height: calc(100vh - 70px);
                top: 70px;
                left: 0;
                transform: translateX(-100%); /* Hidden by default */
                z-index: 95;
            }

            .sidebar.active {
                transform: translateX(0); /* Shown */
            }

            .sidebar-toggle-btn {
                display: block; /* Show on mobile */
            }

            .sidebar-spacer {
                display: none; /* No spacer needed when sidebar is hidden */
            }
            
            .content {
                margin-left: 0;
                padding-bottom: 20px;
            }

            /* Adjust fixed calculator position for mobile */
            .fixed-calculator {
                left: 0;
                top: 70px;
                width: 100%;
            }

            .fixed-calculator .calc-row {
                display: flex;
                flex-wrap: wrap;
                margin-left: 0;
                margin-top: 10px;
                width: 100%;
            }
            .fixed-calculator .calc-input {
                width: 100% !important;
            }
            .fixed-calculator .calc-btn {
                width: 100%;
            }
            .fixed-calculator #quickCalc {
                 width: calc(100% - 10px) !important;
            }
            
        }
        
        @media (max-width: 600px) {
            .header { 
                flex-wrap: wrap; 
                gap: 10px;
                padding: 10px 15px;
            }
            .content { 
                padding: 15px;
                padding-top: 130px;
            }
            .results-stats { 
                flex-direction: column; 
                align-items: center; 
            }
            .sim-content { 
                flex-direction: column; 
            }
            .fixed-calculator {
                padding: 10px 15px;
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.5s ease; }
        
        @keyframes pointsUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-30px); opacity: 0; }
        }
        .points-animation {
            position: fixed;
            color: var(--secondary);
            font-weight: bold;
            font-size: 1.2em;
            pointer-events: none;
            animation: pointsUp 1s ease-out forwards;
            z-index: 1000;
        }
        
        /* Fixed Calculator */
        .fixed-calculator {
            position: fixed;
            top: 70px;
            left: 280px;
            right: 0;
            z-index: 80;
            background: var(--bg-dark);
            border-bottom: 2px solid var(--purple);
            padding: 12px 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            display: none; /* Hidden by default, shown on exercise pages */
        }
        
        .fixed-calculator.show {
            display: block;
        }
        
        .fixed-calculator .calculator-header {
            margin-bottom: 0;
            display: inline;
        }
        
        .fixed-calculator .calc-row {
            margin-bottom: 0;
            display: inline-flex;
            margin-left: 20px;
        }
        
        .calc-toggle-btn {
            background: var(--purple);
            border: none;
            color: white;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            margin-left: 15px;
        }
        
        .calc-toggle-btn:hover {
            background: #9333ea;
        }
        
        .fixed-calculator.collapsed .calc-content {
            display: none;
        }
        
        .fixed-calculator.collapsed {
            padding: 8px 25px;
        }
        
        .calc-expanded-area {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--bg-light);
        }
        
        /* PDF & Email Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .btn-pdf {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-pdf:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-2px);
        }
        
        .btn-email {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-email:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            transform: translateY(-2px);
        }
        
        /* Certificate Section */
        .certificate-section {
            background: rgba(16, 185, 129, 0.1);
            border: 2px solid var(--secondary);
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
            text-align: center;
        }
        
        .certificate-section h3 {
            color: var(--secondary);
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            üìä Digitalisierung Bild & Audio
            <span id="studentDisplay" style="display: none;" class="student-info">
                üë§ <span id="studentNameDisplay"></span>
            </span>
        </div>

        <div class="header-controls">
            <button class="sidebar-toggle-btn" onclick="toggleMobileSidebar()">‚ò∞</button>
            <div id="pointsDisplay" class="points-display" style="display: none;">
                ‚≠ê <span id="totalPointsDisplay">0</span> / <span id="maxPointsDisplay">44</span> Punkte
            </div>
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <div class="progress-text">
                    <span id="progressText">0%</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="main-container">
        <nav class="sidebar" id="sidebar">
            <h3>üìö Kapitel</h3>
            <ul class="module-list" id="moduleList"></ul>
        </nav>
        
        <div class="sidebar-spacer" id="sidebarSpacer"></div>
        
        <div class="fixed-calculator" id="fixedCalc">
            <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 10px;">
                <span class="calculator-header" style="color: var(--purple); font-weight: bold;">üßÆ Rechner</span>
                <div class="calc-row">
                    <input type="text" class="calc-input" id="quickCalc" placeholder="z.B. 300*20/25 oder 2^16" style="width: 280px;" onkeypress="if(event.key==='Enter')quickCalculate()">
                    <button class="calc-btn" onclick="quickCalculate()">= Berechnen</button>
                    <span id="quickResult" style="margin-left: 15px; font-size: 1.1em; color: var(--secondary); font-weight: bold;"></span>
                </div>
                <button class="calc-toggle-btn" onclick="toggleFixedCalc()">
                    <span id="calcToggleText">‚ñº Details</span>
                </button>
            </div>
            <div class="calc-content">
                <div class="calc-expanded-area">
                    <div class="calc-steps" id="quickSteps"></div>
                </div>
            </div>
        </div>
        
        <main class="content" id="content"></main>
    </div>

    <script>
        // ============ STATE (Loaded from/Saved to Local Storage) ============
        const STORAGE_KEY = 'glnf_digitalisierung_state';

        let state = {
            studentName: '',
            currentModule: 'welcome',
            points: 0,
            maxPoints: 63,
            completedModules: new Set(),
            answers: {},
            errors: []
        };

        const initialMaxPoints = 63; // Max points from all exercises (A-D)
        
        // ============ MODULES ============
        const modules = [
            { id: 'welcome', title: 'Start', icon: 'üè†', type: 'welcome' },
            { id: 'formeln', title: 'Formelsammlung', icon: 'üìê', type: 'lesson' },
            { id: 'simulation', title: 'Simulationen', icon: 'üéÆ', type: 'simulation' },
            { id: 'aufgabenA', title: 'A) Skalieren ohne Resampling', icon: 'üîç', type: 'exercises', group: 'A' },
            { id: 'aufgabenB', title: 'B) Umrechnung ppi ‚Üî px/cm', icon: 'üîÑ', type: 'exercises', group: 'B' },
            { id: 'aufgabenC', title: 'C) Bild-Speicherbedarf', icon: 'üíæ', type: 'exercises', group: 'C' },
            { id: 'aufgabenD', title: 'D) Audio-Digitalisierung', icon: 'üéµ', type: 'exercises', group: 'D' },
            { id: 'zusammenfassung', title: 'Zusammenfassung', icon: 'üìä', type: 'results' }
        ];
        
        // ============ EXERCISES DATA (Kept original data) ============
        const exercises = {
            A: [
                {
                    id: 1,
                    question: 'Ein 20 cm breites Bild mit einer Pixelaufl√∂sung von 300 ppi wird ohne Resampling auf 25 cm Breite skaliert. Welche neue Pixelaufl√∂sung (ppi) ergibt sich?',
                    answer: 240,
                    unit: 'ppi',
                    tolerance: 1,
                    points: 2,
                    solution: 'Pixel = 20 cm √ó 300 ppi / 2,54 = 2362 px (konstant)\nNeue ppi = 2362 √ó 2,54 / 25 cm = 240 ppi\nOder: alte ppi √ó (alte Breite / neue Breite) = 300 √ó (20/25) = 240 ppi'
                },
                {
                    id: 2,
                    question: 'Ein 100 mm hohes Bild besitzt eine Pixelaufl√∂sung von 200 px/cm. Es wird ohne Pixelneuberechnung auf 125 mm H√∂he skaliert. Welche Pixelaufl√∂sung in px/cm ergibt sich?',
                    answer: 160,
                    unit: 'px/cm',
                    tolerance: 1,
                    points: 2,
                    solution: 'Pixel = 10 cm √ó 200 px/cm = 2000 px (konstant)\nNeue px/cm = 2000 px / 12,5 cm = 160 px/cm\nOder: alte px/cm √ó (alte H√∂he / neue H√∂he) = 200 √ó (100/125) = 160 px/cm'
                },
                {
                    id: '3a',
                    question: 'Ein Bild der Gr√∂√üe 100 mm √ó 150 mm hat eine Aufl√∂sung von 600 ppi. Ohne Resampling wird es auf 75 mm Breite skaliert. Welche neue Pixelaufl√∂sung ergibt sich?',
                    answer: 800,
                    unit: 'ppi',
                    tolerance: 2,
                    points: 2,
                    solution: 'Neue ppi = alte ppi √ó (alte Breite / neue Breite) = 600 √ó (100/75) = 800 ppi'
                },
                {
                    id: '3b',
                    question: 'Ein Bild der Gr√∂√üe 100 mm √ó 150 mm hat eine Aufl√∂sung von 600 ppi. Ohne Resampling wird es auf 300 mm H√∂he skaliert. Welche neue Pixelaufl√∂sung ergibt sich?',
                    answer: 300,
                    unit: 'ppi',
                    tolerance: 1,
                    points: 2,
                    solution: 'Neue ppi = alte ppi √ó (alte H√∂he / neue H√∂he) = 600 √ó (150/300) = 300 ppi'
                },
                {
                    id: 4,
                    question: 'Welche Pixelaufl√∂sung ergibt sich, wenn ein Bild mit 400 ppi ohne Resampling auf 200% skaliert wird?',
                    answer: 200,
                    unit: 'ppi',
                    tolerance: 1,
                    points: 2,
                    solution: 'Neue ppi = alte ppi / Skalierungsfaktor = 400 / 2 = 200 ppi'
                },
                {
                    id: '5a',
                    question: 'Welche Pixelaufl√∂sung ergibt sich bei Aufl√∂sung 100 ppi und Skalierungsfaktor 50%?',
                    answer: 200,
                    unit: 'ppi',
                    tolerance: 1,
                    points: 1,
                    solution: 'Neue ppi = alte ppi / Skalierungsfaktor = 100 / 0,5 = 200 ppi'
                },
                {
                    id: '5b',
                    question: 'Welche Pixelaufl√∂sung ergibt sich bei Aufl√∂sung 150 px/cm und Skalierungsfaktor 2?',
                    answer: 75,
                    unit: 'px/cm',
                    tolerance: 1,
                    points: 1,
                    solution: 'Neue px/cm = alte px/cm / Skalierungsfaktor = 150 / 2 = 75 px/cm'
                },
                {
                    id: '5c',
                    question: 'Welche Pixelaufl√∂sung ergibt sich bei Aufl√∂sung 600 ppi und Skalierungsverh√§ltnis 1:1,5?',
                    answer: 400,
                    unit: 'ppi',
                    tolerance: 1,
                    points: 1,
                    solution: 'Skalierungsfaktor = 1,5\nNeue ppi = alte ppi / Skalierungsfaktor = 600 / 1,5 = 400 ppi'
                },
                {
                    id: '5d',
                    question: 'Welche Pixelaufl√∂sung ergibt sich bei Aufl√∂sung 200 px/cm und Skalierungsfaktor 300%?',
                    answer: 66.67,
                    unit: 'px/cm',
                    tolerance: 1,
                    points: 1,
                    solution: 'Neue px/cm = alte px/cm / Skalierungsfaktor = 200 / 3 ‚âà 66,67 px/cm'
                },
                {
                    id: 6,
                    question: 'Die Pixelfrequenz eines 30 cm breiten Bildes wird ohne Resampling von 240 ppi auf 300 ppi ge√§ndert. Welche neue Bildbreite (in cm) ergibt sich?',
                    answer: 24,
                    unit: 'cm',
                    tolerance: 0.5,
                    points: 2,
                    solution: 'Pixel = 30 cm √ó 240 ppi / 2,54 = 2835 px (konstant)\nNeue Breite = 2835 √ó 2,54 / 300 = 24 cm\nOder: neue Breite = alte Breite √ó (alte ppi / neue ppi) = 30 √ó (240/300) = 24 cm'
                },
                {
                    id: 7,
                    question: 'Auf welche maximale Breite (in cm) kann ein 10 cm breites Bild mit 300 ppi skaliert werden, wenn die Pixelfrequenz nicht unter 150 ppi fallen darf?',
                    answer: 20,
                    unit: 'cm',
                    tolerance: 0.5,
                    points: 2,
                    solution: 'Max. Breite = alte Breite √ó (alte ppi / min. ppi) = 10 √ó (300/150) = 20 cm'
                },
                {
                    id: '8a',
                    question: 'Ein Bild (200 mm √ó 300 mm, 100 px/cm) wird ohne Resampling auf 50 px/cm ge√§ndert. Welche neue Breite (in mm) ergibt sich?',
                    answer: 400,
                    unit: 'mm',
                    tolerance: 5,
                    points: 2,
                    solution: 'Neue Breite = alte Breite √ó (alte px/cm / neue px/cm) = 200 √ó (100/50) = 400 mm'
                },
                {
                    id: '8b',
                    question: 'Ein Bild (200 mm √ó 300 mm, 100 px/cm) wird ohne Resampling auf 200 px/cm ge√§ndert. Welche neue H√∂he (in mm) ergibt sich?',
                    answer: 150,
                    unit: 'mm',
                    tolerance: 2,
                    points: 2,
                    solution: 'Neue H√∂he = alte H√∂he √ó (alte px/cm / neue px/cm) = 300 √ó (100/200) = 150 mm'
                }
            ],
            B: [
                {
                    id: 9,
                    question: 'Ein 160 mm breites Bild hat eine Aufl√∂sung von 100 px/cm. Welche Breite (in mm) ergibt sich, wenn die Aufl√∂sung ohne Resampling auf 200 px/cm ge√§ndert wird?',
                    answer: 80,
                    unit: 'mm',
                    tolerance: 1,
                    points: 2,
                    solution: 'Neue Breite = alte Breite √ó (alte px/cm / neue px/cm) = 160 √ó (100/200) = 80 mm'
                },
                {
                    id: 10,
                    question: 'Die Aufl√∂sung eines 80 mm hohen Bildes wird ohne Pixelneuberechnung von 300 ppi auf 150 ppi ge√§ndert. Berechnen Sie die neue Bildh√∂he (in mm).',
                    answer: 160,
                    unit: 'mm',
                    tolerance: 2,
                    points: 2,
                    solution: 'Neue H√∂he = alte H√∂he √ó (alte ppi / neue ppi) = 80 √ó (300/150) = 160 mm'
                }
            ],
            C: [
                {
                    id: 11,
                    question: 'Ein Graustufenbild (8 Bit) ist 800 √ó 500 Pixel gro√ü. Berechnen Sie die Bilddatenmenge in Kilobyte (kB = 1000 Byte).',
                    answer: 400,
                    unit: 'kB',
                    tolerance: 5,
                    points: 2,
                    solution: 'Datenmenge = 800 √ó 500 √ó 8 Bit = 3.200.000 Bit\n= 3.200.000 / 8 = 400.000 Byte\n= 400.000 / 1000 = 400 kB'
                },
                {
                    id: '12a',
                    question: 'Welche Datenmenge (in kB) hat ein RGB-Bild, 600 √ó 400 Pixel, Datentiefe 24 Bit?',
                    answer: 720,
                    unit: 'kB',
                    tolerance: 10,
                    points: 1,
                    solution: 'Datenmenge = 600 √ó 400 √ó 24 Bit = 5.760.000 Bit\n= 5.760.000 / 8 = 720.000 Byte\n= 720.000 / 1000 = 720 kB'
                },
                {
                    id: '12b',
                    question: 'Welche Datenmenge (in KiB) hat ein RGB-Bild, 600 √ó 400 Pixel, Datentiefe 24 Bit?',
                    answer: 703.125,
                    unit: 'KiB',
                    tolerance: 5,
                    points: 1,
                    solution: 'Datenmenge = 720.000 Byte / 1024 ‚âà 703,125 KiB'
                },
                {
                    id: 13,
                    question: 'Ein 500 √ó 500 Pixel gro√ües Bild (256 indizierte Farben = 8 Bit) hat einen 10 KiB gro√üen Header. Wie gro√ü ist die gesamte Datei in KiB?',
                    answer: 254.41,
                    unit: 'KiB',
                    tolerance: 3,
                    points: 2,
                    solution: 'Bilddaten = 500 √ó 500 √ó 8 Bit = 2.000.000 Bit\n= 250.000 Byte = 250.000 / 1024 ‚âà 244,14 KiB\nGesamt = 244,14 + 10 ‚âà 254,14 KiB'
                },
                {
                    id: 14,
                    question: 'Ein RGB-Bild (24 Bit) ist 2000 √ó 1500 Pixel gro√ü. Geben Sie die Datenmenge in Megabyte (MB = 10‚Å∂ Byte) an.',
                    answer: 9,
                    unit: 'MB',
                    tolerance: 0.5,
                    points: 2,
                    solution: 'Datenmenge = 2000 √ó 1500 √ó 24 Bit = 72.000.000 Bit\n= 9.000.000 Byte = 9 MB'
                },
                {
                    id: '15a',
                    question: 'Ein Digitalkamerabild (3000 √ó 2000 Pixel, 8 Bit pro RGB-Kanal = 24 Bit gesamt) wird unkomprimiert gespeichert. Berechnen Sie die Datenmenge in MB.',
                    answer: 18,
                    unit: 'MB',
                    tolerance: 0.5,
                    points: 1,
                    solution: 'Datenmenge = 3000 √ó 2000 √ó 24 Bit = 144.000.000 Bit\n= 18.000.000 Byte = 18 MB'
                },
                {
                    id: '15b',
                    question: 'Ein Digitalkamerabild (3000 √ó 2000 Pixel, 8 Bit pro RGB-Kanal = 24 Bit gesamt) wird unkomprimiert gespeichert. Berechnen Sie die Datenmenge in MiB.',
                    answer: 17.166,
                    unit: 'MiB',
                    tolerance: 0.2,
                    points: 1,
                    solution: 'Datenmenge = 18.000.000 Byte / 1.048.576 ‚âà 17,17 MiB'
                },
                {
                    id: 16,
                    question: 'Welche Bilddatenmenge (in MiB) ergibt sich bei einer Bildgr√∂√üe von 2000 √ó 3000 Pixel und einer Datentiefe von 48 Bit?',
                    answer: 34.33,
                    unit: 'MiB',
                    tolerance: 0.5,
                    points: 2,
                    solution: 'Datenmenge = 2000 √ó 3000 √ó 48 Bit = 288.000.000 Bit\n= 36.000.000 Byte = 36.000.000 / 1.048.576 ‚âà 34,33 MiB'
                },
                {
                    id: 17,
                    question: 'Welche Gr√∂√üe in MiB hat eine TIFF-Datei eines CMYK-Bildes (2000 √ó 3000 Pixel, 32 Bit), wenn Header + ICC-Profil 1 MiB gro√ü sind?',
                    answer: 23.89,
                    unit: 'MiB',
                    tolerance: 0.5,
                    points: 2,
                    solution: 'Bilddaten = 2000 √ó 3000 √ó 32 Bit = 192.000.000 Bit\n= 24.000.000 Byte ‚âà 22,89 MiB\nGesamt = 22,89 + 1 = 23,89 MiB'
                },
                {
                    id: '18a',
                    question: 'Ein Strichbild (1 Bit) ist 800 √ó 600 Pixel gro√ü. Berechnen Sie die Bilddatenmenge in Kilobyte (kB).',
                    answer: 60,
                    unit: 'kB',
                    tolerance: 2,
                    points: 1,
                    solution: 'Datenmenge = 800 √ó 600 √ó 1 Bit = 480.000 Bit\n= 60.000 Byte = 60 kB'
                },
                {
                    id: '18b',
                    question: 'Ein Strichbild (1 Bit) ist 800 √ó 600 Pixel gro√ü. Berechnen Sie die Bilddatenmenge in Kibibyte (KiB).',
                    answer: 58.59,
                    unit: 'KiB',
                    tolerance: 1,
                    points: 1,
                    solution: 'Datenmenge = 60.000 Byte / 1024 ‚âà 58,59 KiB'
                },
                {
                    id: 19,
                    question: 'Welche Bilddatenmenge (in MiB) hat ein 8000 √ó 6000 Pixel gro√ües Strichbild (1 Bit)?',
                    answer: 5.72,
                    unit: 'MiB',
                    tolerance: 0.1,
                    points: 2,
                    solution: 'Datenmenge = 8000 √ó 6000 √ó 1 Bit = 48.000.000 Bit\n= 6.000.000 Byte = 6.000.000 / 1.048.576 ‚âà 5,72 MiB'
                },
                {
                    id: '20a',
                    question: 'Ein 4 inch √ó 6 inch gro√ües Graustufenbild hat 200 ppi. Berechnen Sie die Breite in Pixeln.',
                    answer: 800,
                    unit: 'px',
                    tolerance: 5,
                    points: 1,
                    solution: 'Breite = 4 inch √ó 200 ppi = 800 Pixel'
                },
                {
                    id: '20b',
                    question: 'Ein 4 inch √ó 6 inch gro√ües Graustufenbild hat 200 ppi. Berechnen Sie die H√∂he in Pixeln.',
                    answer: 1200,
                    unit: 'px',
                    tolerance: 5,
                    points: 1,
                    solution: 'H√∂he = 6 inch √ó 200 ppi = 1200 Pixel'
                },
                {
                    id: '20c',
                    question: 'Ein 4 inch √ó 6 inch gro√ües Graustufenbild (200 ppi, 16 Bit). Berechnen Sie die Datenmenge in MB.',
                    answer: 1.92,
                    unit: 'MB',
                    tolerance: 0.1,
                    points: 1,
                    solution: 'Pixel = 800 √ó 1200 = 960.000 Pixel\nDatenmenge = 960.000 √ó 16 Bit = 15.360.000 Bit\n= 1.920.000 Byte = 1,92 MB'
                },
                {
                    id: 21,
                    question: 'Berechnen Sie die Dateigr√∂√üe in KiB: Aufl√∂sung 100 ppi, Datentiefe 24 Bit, Bildgr√∂√üe 5 inch √ó 5 inch, Dateikopf 25 KiB.',
                    answer: 757.32,
                    unit: 'KiB',
                    tolerance: 10,
                    points: 2,
                    solution: 'Pixel = 500 √ó 500 = 250.000 Pixel\nBilddaten = 250.000 √ó 24 Bit = 6.000.000 Bit\n= 750.000 Byte ‚âà 732,42 KiB\nGesamt = 732,42 + 25 ‚âà 757,42 KiB'
                },
                {
                    id: '22a',
                    question: 'Ein CMYK-Bild (20 cm √ó 10 cm, 100 px/cm, 32 Bit). Geben Sie die Datenmenge in MB an.',
                    answer: 8,
                    unit: 'MB',
                    tolerance: 0.2,
                    points: 1,
                    solution: 'Pixel = 2000 √ó 1000 = 2.000.000 Pixel\nDatenmenge = 2.000.000 √ó 32 Bit = 64.000.000 Bit\n= 8.000.000 Byte = 8 MB'
                },
                {
                    id: '22b',
                    question: 'Ein CMYK-Bild (20 cm √ó 10 cm, 100 px/cm, 32 Bit). Geben Sie die Datenmenge in MiB an.',
                    answer: 7.63,
                    unit: 'MiB',
                    tolerance: 0.1,
                    points: 1,
                    solution: 'Datenmenge = 8.000.000 Byte / 1.048.576 ‚âà 7,63 MiB'
                }
            ],
            D: [
                {
                    id: 23,
                    question: 'Eine Audio-Datei hat folgende Parameter: Abtastrate 44.100 Hz, Bittiefe 16 Bit, Stereo (2 Kan√§le), Dauer 3 Minuten. Berechnen Sie die Datenmenge in MB.',
                    answer: 31.75,
                    unit: 'MB',
                    tolerance: 0.5,
                    points: 2,
                    solution: 'Samples = 44.100 Hz √ó 180 s = 7.938.000 Samples\nDatenmenge = 7.938.000 √ó 16 Bit √ó 2 Kan√§le = 254.016.000 Bit\n= 31.752.000 Byte = 31,752 MB'
                },
                {
                    id: 24,
                    question: 'Ein Mono-Audiosignal (1 Kanal) wird mit 48 kHz Abtastrate und 24 Bit Aufl√∂sung aufgenommen. Wie gro√ü ist die Datenmenge pro Sekunde in kB?',
                    answer: 144,
                    unit: 'kB',
                    tolerance: 2,
                    points: 2,
                    solution: 'Datenmenge/s = 48.000 Hz √ó 24 Bit √ó 1 Kanal = 1.152.000 Bit/s\n= 144.000 Byte/s = 144 kB/s'
                },
                {
                    id: 25,
                    question: 'Eine CD-Audio hat Standard-Parameter: 44,1 kHz, 16 Bit, Stereo. Wie viele Minuten Musik passen auf eine CD mit 700 MB Kapazit√§t?',
                    answer: 66.14,
                    unit: 'Minuten',
                    tolerance: 2,
                    points: 2,
                    solution: 'Datenrate = 44.100 √ó 16 √ó 2 = 1.411.200 Bit/s = 176.400 Byte/s\n700 MB = 700.000.000 Byte\nDauer = 700.000.000 / 176.400 ‚âà 3.968 s ‚âà 66,14 Minuten'
                },
                {
                    id: 26,
                    question: 'Ein Podcast wird mit 22.050 Hz, 16 Bit, Mono aufgenommen und ist 45 Minuten lang. Berechnen Sie die unkomprimierte Dateigr√∂√üe in MiB.',
                    answer: 113.56,
                    unit: 'MiB',
                    tolerance: 2,
                    points: 2,
                    solution: 'Samples = 22.050 Hz √ó 2.700 s = 59.535.000 Samples\nDatenmenge = 59.535.000 √ó 16 Bit √ó 1 = 952.560.000 Bit\n= 119.070.000 Byte = 119.070.000 / 1.048.576 ‚âà 113,56 MiB'
                },
                {
                    id: 27,
                    question: 'Welche Abtastrate (in Hz) ist mindestens erforderlich, um Frequenzen bis 20 kHz korrekt zu digitalisieren? (Nyquist-Theorem)',
                    answer: 40000,
                    unit: 'Hz',
                    tolerance: 100,
                    points: 1,
                    solution: 'Nach dem Nyquist-Theorem muss die Abtastrate mindestens doppelt so hoch sein wie die h√∂chste zu erfassende Frequenz:\nAbtastrate ‚â• 2 √ó 20.000 Hz = 40.000 Hz'
                },
                {
                    id: 28,
                    question: 'Eine Stereo-Aufnahme mit 96 kHz und 24 Bit ist 5 Minuten lang. Wie gro√ü ist die Datei in MB?',
                    answer: 172.8,
                    unit: 'MB',
                    tolerance: 2,
                    points: 2,
                    solution: 'Datenmenge = 96.000 Hz √ó 24 Bit √ó 2 Kan√§le √ó 300 s\n= 1.382.400.000 Bit = 172.800.000 Byte = 172,8 MB'
                },
                {
                    id: '29a',
                    question: 'Ein Audio-Interface nimmt mit 192 kHz, 32 Bit Float, 8 Kan√§le gleichzeitig auf. Wie hoch ist die Datenrate in MB pro Sekunde?',
                    answer: 6.144,
                    unit: 'MB/s',
                    tolerance: 0.1,
                    points: 2,
                    solution: 'Datenrate = 192.000 Hz √ó 32 Bit √ó 8 Kan√§le = 49.152.000 Bit/s\n= 49.152.000 / 8 = 6.144.000 Byte/s = 6,144 MB/s'
                },
                {
                    id: '29b',
                    question: 'Wie viele Gigabyte (GB) fallen bei der Aufnahme aus Aufgabe 29a in einer Stunde an?',
                    answer: 22.12,
                    unit: 'GB',
                    tolerance: 0.5,
                    points: 1,
                    solution: 'Datenrate = 6,144 MB/s\nPro Stunde = 6,144 √ó 3.600 = 22.118,4 MB ‚âà 22,12 GB'
                },
                {
                    id: 30,
                    question: 'Eine WAV-Datei (44,1 kHz, 16 Bit, Stereo) ist 52,92 MB gro√ü. Wie lang ist die Aufnahme in Sekunden?',
                    answer: 300,
                    unit: 's',
                    tolerance: 5,
                    points: 2,
                    solution: 'Datenrate = 44.100 √ó 16 √ó 2 = 1.411.200 Bit/s = 176.400 Byte/s\n52,92 MB = 52.920.000 Byte\nDauer = 52.920.000 / 176.400 = 300 s (= 5 Minuten)'
                },
                {
                    id: 31,
                    question: 'Ein Sprachrekorder nimmt mit 8 kHz, 8 Bit, Mono auf. Wie viele Stunden Aufnahme passen auf eine 1 GB SD-Karte?',
                    answer: 34.72,
                    unit: 'Stunden',
                    tolerance: 1,
                    points: 2,
                    solution: 'Datenrate = 8.000 √ó 8 √ó 1 = 64.000 Bit/s = 8.000 Byte/s\n1 GB = 1.000.000.000 Byte\nDauer = 1.000.000.000 / 8.000 = 125.000 s\n= 125.000 / 3.600 ‚âà 34,72 Stunden'
                },
                {
                    id: 32,
                    question: 'Wie viele Quantisierungsstufen hat ein Audio-Signal mit 16 Bit Aufl√∂sung?',
                    answer: 65536,
                    unit: 'Stufen',
                    tolerance: 0,
                    points: 1,
                    solution: 'Quantisierungsstufen = 2^Bittiefe = 2^16 = 65.536 Stufen'
                },
                {
                    id: 33,
                    question: 'Ein Vinyl-Rip wird mit 96 kHz / 24 Bit Stereo digitalisiert. Die LP hat 2 Seiten √† 22 Minuten. Gesamtgr√∂√üe in MiB?',
                    answer: 1450.2,
                    unit: 'MiB',
                    tolerance: 20,
                    points: 2,
                    solution: 'Gesamtdauer = 44 Min = 2.640 s\nDatenmenge = 96.000 √ó 24 √ó 2 √ó 2.640 = 12.165.120.000 Bit\n= 1.520.640.000 Byte = 1.520.640.000 / 1.048.576 ‚âà 1.450,2 MiB'
                }
            ]
        };
        
        // ============ HELPER FUNCTIONS (Local Storage) ============
        function saveState() {
            try {
                // Konvertiere Set zu Array f√ºr JSON.stringify
                const stateToSave = {
                    ...state,
                    completedModules: Array.from(state.completedModules)
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(stateToSave));
            } catch (e) {
                console.error("Fehler beim Speichern des Zustands:", e);
            }
        }

        function loadState() {
            try {
                const savedState = localStorage.getItem(STORAGE_KEY);
                if (savedState) {
                    const loadedState = JSON.parse(savedState);
                    // Konvertiere Array zur√ºck zu Set
                    loadedState.completedModules = new Set(loadedState.completedModules);
                    // Aktualisiere den Zustand
                    state = { ...state, ...loadedState };

                    // Initialisiere die UI-Elemente
                    if (state.studentName) {
                        document.getElementById('studentDisplay').style.display = 'flex';
                        document.getElementById('studentNameDisplay').textContent = state.studentName;
                        document.getElementById('pointsDisplay').style.display = 'block';
                    }
                    document.getElementById('maxPointsDisplay').textContent = state.maxPoints;
                }
            } catch (e) {
                console.error("Fehler beim Laden des Zustands:", e);
                // Bei Fehler alten Zustand l√∂schen, um Endlosschleife zu verhindern
                localStorage.removeItem(STORAGE_KEY);
            }
        }

        // ============ RENDER FUNCTIONS ============
        function renderSidebar() {
            const list = document.getElementById('moduleList');
            list.innerHTML = modules.map(m => {
                const isCompleted = state.completedModules.has(m.id);
                const isActive = state.currentModule === m.id;
                return `
                    <li class="module-item">
                        <button class="module-btn ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}" 
                                onclick="navigateTo('${m.id}')">
                            <span class="module-icon">${m.icon}</span>
                            ${m.title}
                        </button>
                    </li>
                `;
            }).join('');
        }
        
        function renderProgress() {
            const total = state.maxPoints;
            const current = state.points;
            const percent = Math.round((current / total) * 100);
            
            document.getElementById('progressFill').style.width = `${percent}%`;
            document.getElementById('progressText').textContent = `${percent}%`;
            document.getElementById('totalPointsDisplay').textContent = current;
            document.getElementById('maxPointsDisplay').textContent = total;
        }
        
        function renderContent() {
            const module = modules.find(m => m.id === state.currentModule);
            const content = document.getElementById('content');
            
            if (!module) return;
            
            // Show/hide fixed calculator based on module type
            const showCalc = module.type === 'exercises' || module.type === 'simulation';
            showFixedCalc(showCalc);

            // Hide mobile sidebar on content change
            const sidebar = document.getElementById('sidebar');
            if (sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
            }
            
            switch (module.type) {
                case 'welcome':
                    content.innerHTML = renderWelcome();
                    break;
                case 'lesson':
                    content.innerHTML = renderFormeln();
                    break;
                case 'simulation':
                    content.innerHTML = renderSimulation();
                    setTimeout(initSimulators, 100);
                    break;
                case 'exercises':
                    content.innerHTML = renderExercises(module.group);
                    break;
                case 'results':
                    content.innerHTML = renderResults();
                    break;
            }
        }
        
        function renderWelcome() {
            if (!state.studentName) {
                return `
                    <div class="name-input-container fade-in">
                        <h2>üë§ Willkommen!</h2>
                        <p style="color: var(--text-muted); margin-bottom: 20px;">Bitte gib deinen Namen ein:</p>
                        <input type="text" class="name-input" id="nameInput" placeholder="Dein Name" 
                               onkeypress="if(event.key==='Enter')startCourse()">
                        <br><br>
                        <button class="start-btn" onclick="startCourse()">Kurs starten üöÄ</button>
                    </div>
                `;
            }
            
            return `
                <div class="welcome-hero fade-in">
                    <h1>üìä Digitalisierung von Bilddaten & Audiodaten</h1>
                    <p>Lerne die wichtigsten Berechnungen rund um digitale Bilder und Audio: Pixelaufl√∂sung, Skalierung, Abtastrate und Speicherbedarf.</p>
                    <button class="start-btn" onclick="navigateTo('formeln')">Zur Formelsammlung üìê</button>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div class="section" style="text-align: center;">
                        <h2>üìê Formelsammlung</h2>
                        <p>Alle wichtigen Formeln f√ºr Bild und Audio auf einen Blick.</p>
                    </div>
                    <div class="section" style="text-align: center;">
                        <h2>üéÆ Interaktive Simulationen</h2>
                        <p>Verstehe die Zusammenh√§nge durch praktische Experimente.</p>
                    </div>
                    <div class="section" style="text-align: center;">
                        <h2>üìù 33 √úbungsaufgaben</h2>
                        <p>Bild- und Audio-Berechnungen mit automatischer Auswertung.</p>
                    </div>
                    <div class="section" style="text-align: center;">
                        <h2>üßÆ Integrierter Rechner</h2>
                        <p>Taschenrechner mit dokumentierten Rechenschritten.</p>
                    </div>
                </div>
            `;
        }
        
        function renderFormeln() {
            return `
                <div class="fade-in">
                    <h1 style="color: var(--primary); margin-bottom: 30px;">üìê Formelsammlung</h1>
                    
                    <div class="section">
                        <h2>üî¢ Grundlegende Einheiten</h2>
                        <table class="formula-table">
                            <tr>
                                <th>Einheit</th>
                                <th>Bedeutung</th>
                                <th>Umrechnung</th>
                            </tr>
                            <tr>
                                <td><code>ppi</code></td>
                                <td>Pixels per Inch (Pixel pro Zoll)</td>
                                <td>1 inch = 2,54 cm</td>
                            </tr>
                            <tr>
                                <td><code>px/cm</code></td>
                                <td>Pixel pro Zentimeter</td>
                                <td>px/cm √ó 2,54 = ppi</td>
                            </tr>
                            <tr>
                                <td><code>kB</code></td>
                                <td>Kilobyte (dezimal, 10¬≥)</td>
                                <td>1 kB = 1.000 Byte</td>
                            </tr>
                            <tr>
                                <td><code>KiB</code></td>
                                <td>Kibibyte (bin√§r, 2¬π‚Å∞)</td>
                                <td>1 KiB = 1.024 Byte</td>
                            </tr>
                            <tr>
                                <td><code>MB</code></td>
                                <td>Megabyte (dezimal, 10‚Å∂)</td>
                                <td>1 MB = 1.000.000 Byte</td>
                            </tr>
                            <tr>
                                <td><code>MiB</code></td>
                                <td>Mebibyte (bin√§r, 2¬≤‚Å∞)</td>
                                <td>1 MiB = 1.048.576 Byte</td>
                            </tr>
                        </table>
                        <div class="tip-box">
                            <strong>üí° Wichtig:</strong> Festplattenhersteller nutzen oft die dezimale Basis (MB, GB), w√§hrend Betriebssysteme und Programme die bin√§re Basis (MiB, GiB) zur Anzeige verwenden.
                        </div>
                    </div>
                    
                    <div class="section">
                        <h2>üîç Skalieren ohne Resampling</h2>
                        <p>Beim Skalieren <strong>ohne Resampling</strong> bleibt die <strong>Pixelanzahl konstant</strong>. Nur die physische Gr√∂√üe und die Aufl√∂sung √§ndern sich.</p>
                        
                        <div class="theory-box">
                            <h4>Grundprinzip</h4>
                            <p><strong>Pixel = konstant</strong> ‚Üí Wenn die Gr√∂√üe steigt, sinkt die Aufl√∂sung (und umgekehrt)</p>
                        </div>
                        
                        <div class="formula-box">
                            Neue Aufl√∂sung = Alte Aufl√∂sung √ó (Alte Gr√∂√üe / Neue Gr√∂√üe)
                        </div>
                        
                        <div class="formula-box">
                            Neue Aufl√∂sung = Alte Aufl√∂sung / Skalierungsfaktor
                        </div>
                        
                        <div class="formula-box">
                            Neue Gr√∂√üe = Alte Gr√∂√üe √ó (Alte Aufl√∂sung / Neue Aufl√∂sung)
                        </div>
                        
                        <div class="tip-box">
                            <strong>üí° Tipp:</strong> Bei Skalierung auf 200% wird das Bild doppelt so gro√ü ‚Üí Aufl√∂sung halbiert sich!
                        </div>
                    </div>
                    
                    <div class="section">
                        <h2>üîÑ Umrechnung ppi ‚Üî px/cm</h2>
                        
                        <div class="formula-box">
                            ppi = px/cm √ó 2,54
                        </div>
                        
                        <div class="formula-box">
                            px/cm = ppi / 2,54
                        </div>
                        
                        <table class="formula-table">
                            <tr>
                                <th>px/cm</th>
                                <th>ppi</th>
                            </tr>
                            <tr><td>100</td><td>254</td></tr>
                            <tr><td>118,11</td><td>‚âà 300</td></tr>
                            <tr><td>150</td><td>381</td></tr>
                            <tr><td>200</td><td>508</td></tr>
                        </table>
                    </div>
                    
                    <div class="section">
                        <h2>üíæ Speicherbedarf / Bilddatenmenge</h2>
                        
                        <div class="formula-box">
                            Datenmenge (Bit) = Breite (px) √ó H√∂he (px) √ó Farbtiefe (Bit)
                        </div>
                        
                        <div class="formula-box">
                            Datenmenge (Byte) = Datenmenge (Bit) / 8
                        </div>
                        
                        <table class="formula-table">
                            <tr>
                                <th>Bildtyp</th>
                                <th>Farbtiefe</th>
                                <th>Kan√§le</th>
                            </tr>
                            <tr><td>Strichbild (s/w)</td><td>1 Bit</td><td>1</td></tr>
                            <tr><td>Graustufen</td><td>8 Bit oder 16 Bit</td><td>1</td></tr>
                            <tr><td>Indiziert (256 Farben)</td><td>8 Bit</td><td>1 + Palette</td></tr>
                            <tr><td>RGB</td><td>24 Bit (3√ó8) oder 48 Bit (3√ó16)</td><td>3</td></tr>
                            <tr><td>CMYK</td><td>32 Bit (4√ó8) oder 64 Bit (4√ó16)</td><td>4</td></tr>
                        </table>
                        
                        <div class="warning-box">
                            <strong>‚ö†Ô∏è Wichtig:</strong> Bei Dateigr√∂√üen m√ºssen Header, ICC-Profile etc. hinzugerechnet werden!
                        </div>
                    </div>
                    
                    <div class="section">
                        <h2>üìè Pixelanzahl berechnen</h2>
                        
                        <div class="formula-box">
                            Pixel = Gr√∂√üe (inch) √ó Aufl√∂sung (ppi)
                        </div>
                        
                        <div class="formula-box">
                            Pixel = Gr√∂√üe (cm) √ó Aufl√∂sung (px/cm)
                        </div>
                        
                        <div class="formula-box">
                            Pixel = Gr√∂√üe (cm) √ó Aufl√∂sung (ppi) / 2,54
                        </div>
                    </div>
                    
                    <div class="section" style="border-color: var(--purple);">
                        <h2 style="color: var(--purple);">üéµ Audio-Digitalisierung</h2>
                        
                        <div class="theory-box" style="border-color: var(--purple); background: rgba(168, 85, 247, 0.1);">
                            <h4 style="color: var(--purple);">Grundbegriffe</h4>
                            <ul style="margin: 10px 0 0 20px;">
                                <li><strong>Abtastrate (Sample Rate):</strong> Wie oft pro Sekunde das Signal gemessen wird (in Hz oder kHz)</li>
                                <li><strong>Bittiefe (Bit Depth):</strong> Genauigkeit jeder Messung (8, 16, 24 Bit)</li>
                                <li><strong>Kan√§le:</strong> Mono = 1, Stereo = 2, Surround = 6+</li>
                            </ul>
                        </div>
                        
                        <div class="formula-box" style="border-color: var(--purple);">
                            Datenmenge (Bit) = Abtastrate (Hz) √ó Bittiefe √ó Kan√§le √ó Dauer (s)
                        </div>
                        
                        <div class="formula-box" style="border-color: var(--purple);">
                            Datenrate (Bit/s) = Abtastrate (Hz) √ó Bittiefe √ó Kan√§le
                        </div>
                        
                        <table class="formula-table">
                            <tr>
                                <th>Standard</th>
                                <th>Abtastrate</th>
                                <th>Bittiefe</th>
                                <th>Kan√§le</th>
                            </tr>
                            <tr><td>Telefon</td><td>8.000 Hz</td><td>8 Bit</td><td>Mono</td></tr>
                            <tr><td>CD-Audio</td><td>44.100 Hz</td><td>16 Bit</td><td>Stereo</td></tr>
                            <tr><td>DVD-Audio</td><td>48.000 Hz</td><td>16/24 Bit</td><td>Stereo/5.1</td></tr>
                            <tr><td>Studio Hi-Res</td><td>96.000 Hz</td><td>24 Bit</td><td>Stereo</td></tr>
                            <tr><td>Studio Max</td><td>192.000 Hz</td><td>32 Bit</td><td>Mehrkanal</td></tr>
                        </table>
                        
                        <div class="tip-box" style="border-color: var(--purple); background: rgba(168, 85, 247, 0.1);">
                            <strong>üí° Nyquist-Theorem:</strong> Die Abtastrate muss mindestens <strong>doppelt so hoch</strong> sein wie die h√∂chste zu erfassende Frequenz.<br>
                            Beispiel: F√ºr 20 kHz (menschliches H√∂ren) ‚Üí mindestens 40 kHz Abtastrate
                        </div>
                        
                        <div class="warning-box">
                            <strong>‚ö†Ô∏è Quantisierungsstufen:</strong> Anzahl = 2<sup>Bittiefe</sup><br>
                            8 Bit = 256 Stufen | 16 Bit = 65.536 Stufen | 24 Bit = 16.777.216 Stufen
                        </div>
                    </div>
                    
                    <div class="nav-buttons">
                        <button class="btn btn-primary" onclick="navigateTo('welcome')">‚Üê Zur√ºck</button>
                        <button class="btn btn-success" onclick="navigateTo('simulation')">Zu den Simulationen ‚Üí</button>
                    </div>
                </div>
            `;
        }
        
        function renderSimulation() {
            return `
                <div class="fade-in">
                    <h1 style="color: var(--primary); margin-bottom: 30px;">üéÆ Interaktive Simulationen</h1>
                    
                    <div class="section">
                        <h2>üîç Simulation 1: Skalieren ohne Resampling</h2>
                        <p>Ver√§ndere die Bildgr√∂√üe und beobachte, wie sich die Aufl√∂sung √§ndert (Pixelanzahl bleibt konstant).</p>
                        
                        <div class="simulator">
                            <div class="sim-header">üîß Parameter einstellen</div>
                            <div class="input-row" style="justify-content: center; margin-bottom: 20px;">
                                <span class="input-label" style="width: auto;">Einheiten:</span>
                                <select id="sim1Unit" style="padding: 8px 15px; background: var(--bg-card); border: 2px solid var(--bg-light); border-radius: 8px; color: var(--text);" onchange="updateSim1Units()">
                                    <option value="cm_ppi">cm & ppi</option>
                                    <option value="mm_pxcm">mm & px/cm</option>
                                </select>
                            </div>
                            <div class="sim-content">
                                <div class="input-controls">
                                    <div class="input-row">
                                        <span class="input-label" id="sim1WidthLabel">Urspr. Breite:</span>
                                        <div class="slider-container">
                                            <input type="range" class="slider" id="sim1Width" min="5" max="50" value="20">
                                            <span class="slider-value" id="sim1WidthVal">20 cm</span>
                                        </div>
                                    </div>
                                    <div class="input-row">
                                        <span class="input-label" id="sim1PpiLabel">Urspr. ppi:</span>
                                        <div class="slider-container">
                                            <input type="range" class="slider" id="sim1Ppi" min="72" max="600" value="300" step="1">
                                            <span class="slider-value" id="sim1PpiVal">300 ppi</span>
                                        </div>
                                    </div>
                                    <div class="input-row">
                                        <span class="input-label" id="sim1NewWidthLabel">Neue Breite:</span>
                                        <div class="slider-container">
                                            <input type="range" class="slider" id="sim1NewWidth" min="5" max="50" value="25">
                                            <span class="slider-value" id="sim1NewWidthVal">25 cm</span>
                                        </div>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                                    <div class="output-display">
                                        <div class="output-value" id="sim1Pixels">2362</div>
                                        <div class="output-label">Pixel (konstant)</div>
                                    </div>
                                    <div class="output-display">
                                        <div class="output-value" id="sim1NewPpi">240</div>
                                        <div class="output-label" id="sim1NewPpiLabel">Neue ppi</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h2>üíæ Simulation 2: Bild-Speicherbedarf</h2>
                        <p>Ver√§ndere die Bildparameter und beobachte, wie sich der Speicherbedarf √§ndert.</p>
                        
                        <div class="simulator">
                            <div class="sim-header">üîß Bildparameter</div>
                            <div class="sim-content">
                                <div class="input-controls">
                                    <div class="input-row">
                                        <span class="input-label">Breite (px):</span>
                                        <div class="slider-container">
                                            <input type="range" class="slider" id="sim2Width" min="100" max="4000" value="1920" step="10">
                                            <span class="slider-value" id="sim2WidthVal">1920 px</span>
                                        </div>
                                    </div>
                                    <div class="input-row">
                                        <span class="input-label">H√∂he (px):</span>
                                        <div class="slider-container">
                                            <input type="range" class="slider" id="sim2Height" min="100" max="4000" value="1080" step="10">
                                            <span class="slider-value" id="sim2HeightVal">1080 px</span>
                                        </div>
                                    </div>
                                    <div class="input-row">
                                        <span class="input-label">Farbtiefe:</span>
                                        <select id="sim2Depth" style="padding: 8px 15px; background: var(--bg-card); border: 2px solid var(--bg-light); border-radius: 8px; color: var(--text);">
                                            <option value="1">1 Bit (Strich)</option>
                                            <option value="8">8 Bit (Graustufen)</option>
                                            <option value="24" selected>24 Bit (RGB)</option>
                                            <option value="32">32 Bit (CMYK)</option>
                                            <option value="48">48 Bit (RGB 16)</option>
                                        </select>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                                    <div class="output-display">
                                        <div class="output-value" id="sim2Megapixel">2.07</div>
                                        <div class="output-label">Megapixel</div>
                                    </div>
                                    <div class="output-display">
                                        <div class="output-value" id="sim2MB">5.93</div>
                                        <div class="output-label">MB</div>
                                    </div>
                                    <div class="output-display">
                                        <div class="output-value" id="sim2MiB">5.66</div>
                                        <div class="output-label">MiB</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section" style="border-color: var(--purple);">
                        <h2 style="color: var(--purple);">üéµ Simulation 3: Audio-Speicherbedarf</h2>
                        <p>Ver√§ndere die Audio-Parameter und beobachte, wie sich der Speicherbedarf √§ndert.</p>
                        
                        <div class="simulator" style="border: 1px solid var(--purple);">
                            <div class="sim-header" style="color: var(--purple);">üéß Audio-Parameter</div>
                            <div class="sim-content">
                                <div class="input-controls">
                                    <div class="input-row">
                                        <span class="input-label">Abtastrate:</span>
                                        <select id="sim3SampleRate" style="padding: 8px 15px; background: var(--bg-card); border: 2px solid var(--bg-light); border-radius: 8px; color: var(--text);">
                                            <option value="8000">8.000 Hz (Telefon)</option>
                                            <option value="22050">22.050 Hz (Radio)</option>
                                            <option value="44100" selected>44.100 Hz (CD)</option>
                                            <option value="48000">48.000 Hz (DVD)</option>
                                            <option value="96000">96.000 Hz (Hi-Res)</option>
                                            <option value="192000">192.000 Hz (Studio)</option>
                                        </select>
                                    </div>
                                    <div class="input-row">
                                        <span class="input-label">Bittiefe:</span>
                                        <select id="sim3BitDepth" style="padding: 8px 15px; background: var(--bg-card); border: 2px solid var(--bg-light); border-radius: 8px; color: var(--text);">
                                            <option value="8">8 Bit</option>
                                            <option value="16" selected>16 Bit</option>
                                            <option value="24">24 Bit</option>
                                            <option value="32">32 Bit</option>
                                        </select>
                                    </div>
                                    <div class="input-row">
                                        <span class="input-label">Kan√§le:</span>
                                        <select id="sim3Channels" style="padding: 8px 15px; background: var(--bg-card); border: 2px solid var(--bg-light); border-radius: 8px; color: var(--text);">
                                            <option value="1">Mono (1)</option>
                                            <option value="2" selected>Stereo (2)</option>
                                            <option value="6">5.1 Surround (6)</option>
                                            <option value="8">7.1 Surround (8)</option>
                                        </select>
                                    </div>
                                    <div class="input-row">
                                        <span class="input-label">Dauer:</span>
                                        <div class="slider-container">
                                            <input type="range" class="slider" id="sim3Duration" min="1" max="600" value="180" step="1">
                                            <span class="slider-value" id="sim3DurationVal">3:00 min</span>
                                        </div>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                                    <div class="output-display">
                                        <div class="output-value" id="sim3Bitrate" style="color: var(--purple);">1411</div>
                                        <div class="output-label">kBit/s</div>
                                    </div>
                                    <div class="output-display">
                                        <div class="output-value" id="sim3MB" style="color: var(--purple);">31.75</div>
                                        <div class="output-label">MB</div>
                                    </div>
                                    <div class="output-display">
                                        <div class="output-value" id="sim3MiB" style="color: var(--purple);">30.28</div>
                                        <div class="output-label">MiB</div>
                                    </div>
                                </div>
                            </div>
                            <div class="quantization-steps">
                                Quantisierungsstufen: <span id="sim3Steps">65536</span> (2^Bittiefe)
                            </div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h2>üßÆ Online-Taschenrechner</h2>
                        <p>Berechne Werte mit dokumentierten Rechenschritten.</p>
                        
                        <div class="calculator-container">
                            <div class="calculator-header">üßÆ Universalrechner</div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="color: var(--text-muted);">Berechnungstyp:</label>
                                <select id="calcType" onchange="updateCalculator()" style="padding: 10px 15px; background: var(--bg-card); border: 2px solid var(--bg-light); border-radius: 8px; color: var(--text); margin-left: 10px;">
                                    <option value="scaling">Bild: Skalierung ohne Resampling</option>
                                    <option value="storage">Bild: Speicherbedarf</option>
                                    <option value="pixels">Bild: Pixelanzahl</option>
                                    <option value="audio">Audio: Speicherbedarf</option>
                                    <option value="convert">Einheiten umrechnen</option>
                                </select>
                            </div>
                            
                            <div id="calcInputs"></div>
                            
                            <button class="calc-btn" onclick="calculate()">Berechnen üî¢</button>
                            
                            <div class="calc-steps" id="calcSteps"></div>
                        </div>
                    </div>
                    
                    <div class="nav-buttons">
                        <button class="btn btn-primary" onclick="navigateTo('formeln')">‚Üê Formelsammlung</button>
                        <button class="btn btn-success" onclick="navigateTo('aufgabenA')">Zu den Aufgaben ‚Üí</button>
                    </div>
                </div>
            `;
        }
        
        function renderExercises(group) {
            const groupExercises = exercises[group];
            const groupNames = { A: 'Skalieren ohne Resampling', B: 'Umrechnung ppi ‚Üî px/cm', C: 'Bild-Speicherbedarf', D: 'Audio-Digitalisierung' };
            
            let totalPoints = groupExercises.reduce((sum, ex) => sum + ex.points, 0);
            
            return `
                <div class="fade-in">
                    <h1 style="color: var(--primary); margin-bottom: 10px;">üìù Teil ${group}: ${groupNames[group]}</h1>
                    <p style="color: var(--text-muted); margin-bottom: 30px;">
                        ${groupExercises.length} Aufgaben ‚Ä¢ ${totalPoints} Punkte m√∂glich
                    </p>
                    
                    ${groupExercises.map(ex => renderExercise(ex, group)).join('')}
                    
                    <div class="nav-buttons">
                        ${group === 'A' ? `<button class="btn btn-primary" onclick="navigateTo('simulation')">‚Üê Simulationen</button>` : ''}
                        ${group === 'B' ? `<button class="btn btn-primary" onclick="navigateTo('aufgabenA')">‚Üê Teil A</button>` : ''}
                        ${group === 'C' ? `<button class="btn btn-primary" onclick="navigateTo('aufgabenB')">‚Üê Teil B</button>` : ''}
                        ${group === 'D' ? `<button class="btn btn-primary" onclick="navigateTo('aufgabenC')">‚Üê Teil C</button>` : ''}
                        
                        ${group === 'A' ? `<button class="btn btn-success" onclick="navigateTo('aufgabenB')">Teil B ‚Üí</button>` : ''}
                        ${group === 'B' ? `<button class="btn btn-success" onclick="navigateTo('aufgabenC')">Teil C ‚Üí</button>` : ''}
                        ${group === 'C' ? `<button class="btn btn-success" onclick="navigateTo('aufgabenD')">Teil D (Audio) ‚Üí</button>` : ''}
                        ${group === 'D' ? `<button class="btn btn-success" onclick="navigateTo('zusammenfassung')">Zur Auswertung ‚Üí</button>` : ''}
                    </div>
                </div>
            `;
        }
        
        function renderExercise(ex, group) {
            const answerId = `${group}_${ex.id}`;
            const existingAnswer = state.answers[answerId];
            const isAnswered = existingAnswer !== undefined;
            const isCorrect = isAnswered && existingAnswer.correct;

            // Neue Struktur f√ºr L√∂sungsweg (toggleable details)
            const solutionDetails = `
                <div class="solution-details" id="solution_details_${answerId}">
                    <strong>L√∂sung:</strong>
                    <pre style="white-space: pre-wrap; font-family: monospace; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px; margin-top: 10px;">${ex.solution}</pre>
                </div>
            `;
            
            return `
                <div class="exercise-container ${isAnswered ? (isCorrect ? 'correct' : 'incorrect') : ''}" id="ex_${answerId}">
                    <div class="exercise-header">
                        <span class="exercise-number">Aufgabe ${ex.id}</span>
                        <span class="exercise-points">${ex.points} ${ex.points === 1 ? 'Punkt' : 'Punkte'}</span>
                    </div>
                    <div class="exercise-question">${ex.question}</div>
                    
                    <div class="answer-row">
                        <input type="text" step="any" class="answer-input ${isAnswered ? (isCorrect ? 'correct' : 'incorrect') : ''}" 
                               id="input_${answerId}" 
                               placeholder="Antwort"
                               value="${existingAnswer ? existingAnswer.given.toLocaleString('de-DE') : ''}"
                               ${isAnswered ? 'disabled' : ''}>
                        <span class="answer-unit">${ex.unit}</span>
                        <button class="check-btn" onclick="checkAnswer('${group}', '${ex.id}')" 
                                ${isAnswered ? 'disabled' : ''}>
                            ${isAnswered ? (isCorrect ? '‚úì Richtig' : '‚úó Falsch') : 'Pr√ºfen'}
                        </button>
                    </div>
                    
                    <div class="feedback ${isAnswered ? 'show' : ''} ${isAnswered ? (isCorrect ? 'correct' : 'incorrect') : ''}" id="feedback_${answerId}">
                        ${isAnswered ? (isCorrect ? 
                            `<strong>‚úì Richtig!</strong> +${ex.points} Punkte 
                             <span class="solution-toggle" onclick="toggleSolution('${answerId}')">L√∂sungsweg anzeigen</span>
                             ${solutionDetails}` : 
                            `<strong>‚úó Leider falsch.</strong> Deine Antwort: ${existingAnswer.given.toLocaleString('de-DE')} ${ex.unit}<br>Richtige Antwort: ${ex.answer} ${ex.unit} (Toleranz: ¬±${ex.tolerance})<br><br><strong>L√∂sung:</strong><br><pre style="white-space: pre-wrap; font-family: monospace; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px; margin-top: 10px;">${ex.solution}</pre>`
                        ) : ''}
                    </div>
                </div>
            `;
        }
        
        function renderResults() {
            const allExercises = [...exercises.A, ...exercises.B, ...exercises.C, ...exercises.D];
            const totalExercises = allExercises.length;
            const answeredCount = Object.keys(state.answers).length;
            const correctCount = Object.values(state.answers).filter(a => a.correct).length;
            const percentage = totalExercises > 0 ? Math.round((correctCount / totalExercises) * 100) : 0;
            
            const scoreClass = percentage >= 80 ? 'excellent' : percentage >= 50 ? 'good' : 'needs-work';
            const scoreEmoji = percentage >= 80 ? 'üèÜ' : percentage >= 50 ? 'üëç' : 'üìö';
            
            // Collect errors
            const errorsList = [];
            for (const [key, value] of Object.entries(state.answers)) {
                if (!value.correct) {
                    const [group, id] = key.split('_');
                    const ex = exercises[group].find(e => String(e.id) === id);
                    if (ex) {
                        errorsList.push({
                            id: ex.id,
                            question: ex.question,
                            given: value.given,
                            correct: ex.answer,
                            unit: ex.unit,
                            solution: ex.solution
                        });
                    }
                }
            }
            
            return `
                <div class="fade-in">
                    <div class="results-summary">
                        <h2>${scoreEmoji} Deine Ergebnisse</h2>
                        
                        <div class="results-stats">
                            <div class="stat-box">
                                <div class="stat-value ${scoreClass}">${percentage}%</div>
                                <div class="stat-label">Gesamtergebnis</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" style="color: var(--secondary);">${state.points}</div>
                                <div class="stat-label">von ${state.maxPoints} Punkten</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" style="color: var(--primary);">${correctCount}/${totalExercises}</div>
                                <div class="stat-label">Aufgaben richtig</div>
                            </div>
                        </div>
                        
                        <p style="color: var(--text-muted); font-size: 1.1em;">
                            ${percentage >= 80 ? 'Hervorragend! Du hast das Thema sehr gut verstanden!' :
                              percentage >= 50 ? 'Gut gemacht! Mit etwas √úbung wird es noch besser.' :
                              'Schau dir die Formelsammlung nochmal an und √ºbe weiter!'}
                        </p>
                        
                        ${answeredCount < totalExercises ? `
                            <div class="warning-box" style="margin-top: 20px;">
                                <strong>‚ö†Ô∏è Hinweis:</strong> Du hast erst ${answeredCount} von ${totalExercises} Aufgaben beantwortet.
                            </div>
                        ` : ''}
                    </div>
                    
                    ${errorsList.length > 0 ? `
                        <div class="errors-list">
                            <h3>‚ùå Aufgaben mit Rechenfehlern (${errorsList.length})</h3>
                            ${errorsList.map(err => `
                                <div class="error-item">
                                    <div class="error-question"><strong>Aufgabe ${err.id}:</strong> ${err.question}</div>
                                    <div class="error-details">
                                        <span class="error-given">Deine Antwort: ${err.given.toLocaleString('de-DE')} ${err.unit}</span>
                                        <span class="error-correct">Richtig: ${err.correct} ${err.unit}</span>
                                    </div>
                                    <details style="margin-top: 10px;">
                                        <summary style="cursor: pointer; color: var(--primary);">L√∂sungsweg anzeigen</summary>
                                        <pre style="white-space: pre-wrap; font-family: monospace; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 0.9em;">${err.solution}</pre>
                                    </details>
                                </div>
                            `).join('')}
                        </div>
                    ` : (answeredCount === totalExercises && answeredCount > 0) ? `
                        <div class="section" style="text-align: center; border-color: var(--secondary);">
                            <h2 style="color: var(--secondary);">üéâ Perfekt!</h2>
                            <p>Du hast alle Aufgaben richtig gel√∂st!</p>
                        </div>
                    ` : ''}
                    
                    <div class="certificate-section">
                        <h3>üìÑ Ergebnisse speichern & versenden</h3>
                        <p style="color: var(--text-muted); margin-bottom: 20px;">
                            Speichere deine Ergebnisse als PDF oder sende sie per E-Mail an deinen Lehrer.
                        </p>
                        <div class="action-buttons">
                            <button class="btn btn-pdf" onclick="generatePDF()">
                                üì• Als PDF speichern
                            </button>
                            <button class="btn btn-email" onclick="sendEmail()">
                                üìß Per E-Mail senden
                            </button>
                        </div>
                    </div>
                    
                    <div class="nav-buttons">
                        <button class="btn btn-primary" onclick="navigateTo('aufgabenA')">‚Üê Zur√ºck zu den Aufgaben</button>
                        <button class="btn btn-success" onclick="resetCourse()">üîÑ Kurs neu starten</button>
                    </div>
                </div>
            `;
        }

        function toggleSolution(answerId) {
            const details = document.getElementById(`solution_details_${answerId}`);
            if (details) {
                details.style.display = details.style.display === 'block' ? 'none' : 'block';
            }
        }
        
        // ============ INTERACTION FUNCTIONS ============
        function startCourse() {
            const nameInput = document.getElementById('nameInput');
            if (nameInput && nameInput.value.trim()) {
                state.studentName = nameInput.value.trim();
                document.getElementById('studentDisplay').style.display = 'flex';
                document.getElementById('studentNameDisplay').textContent = state.studentName;
                document.getElementById('pointsDisplay').style.display = 'block';
                saveState();
                render();
            }
        }
        
        function navigateTo(moduleId) {
            state.currentModule = moduleId;
            saveState();
            render();
            window.scrollTo(0, 0);
        }
        
        function checkAnswer(group, id) {
            const answerId = `${group}_${id}`;
            const input = document.getElementById(`input_${answerId}`);
            const exercise = exercises[group].find(e => String(e.id) === String(id));
            
            if (!input || !exercise) return;
            
            // NEW: Komma-Ersetzung und Parsing
            const cleanedValue = input.value.replace(',', '.');
            const givenValue = parseFloat(cleanedValue);

            if (isNaN(givenValue)) {
                alert('Bitte gib eine g√ºltige Zahl ein (Trennzeichen ist Punkt oder Komma)!');
                return;
            }
            
            const correctValue = exercise.answer;
            const tolerance = exercise.tolerance;
            const isCorrect = Math.abs(givenValue - correctValue) <= tolerance;
            
            // Check if already answered to prevent double points
            if (state.answers[answerId] && state.answers[answerId].correct) {
                 // Already correct, do nothing
                 return;
            }

            state.answers[answerId] = {
                given: givenValue,
                correct: isCorrect
            };
            
            if (isCorrect) {
                state.points += exercise.points;
                showPointsAnimation(exercise.points);
                // Entferne Fehler, falls vorhanden (obwohl das bei der aktuellen Logik nicht passieren sollte)
                state.errors = state.errors.filter(e => e.id !== exercise.id);
            } else {
                 // F√ºge Fehler nur hinzu, wenn er nicht schon da ist und falsch beantwortet wurde
                 if (!state.errors.some(e => e.id === exercise.id)) {
                    state.errors.push({
                        id: exercise.id,
                        question: exercise.question,
                        given: givenValue,
                        correct: correctValue,
                        unit: exercise.unit
                    });
                 }
            }
            
            // Mark module as completed (always)
            if (modules.find(m => m.id === state.currentModule && m.type === 'exercises')) {
                // Pr√ºfen, ob alle Aufgaben im Modul beantwortet sind
                const allAnswered = exercises[group].every(ex => state.answers[`${group}_${ex.id}`] !== undefined);
                if (allAnswered) {
                    state.completedModules.add(state.currentModule);
                }
            }


            saveState();
            
            // Update UI (partial rerender for the exercise)
            const container = document.getElementById(`ex_${answerId}`);
            container.outerHTML = renderExercise(exercise, group);

            renderProgress();

            // Scroll to next exercise if present
            const nextIndex = exercises[group].findIndex(e => String(e.id) === String(id)) + 1;
            if (nextIndex < exercises[group].length) {
                const nextEx = exercises[group][nextIndex];
                const nextInput = document.getElementById(`input_${group}_${nextEx.id}`);
                if (nextInput) {
                    nextInput.focus();
                }
            }

        }
        
        function showPointsAnimation(points) {
            const pointsDisplay = document.getElementById('pointsDisplay');
            if (!pointsDisplay) return;

            const rect = pointsDisplay.getBoundingClientRect();

            const anim = document.createElement('div');
            anim.className = 'points-animation';
            anim.textContent = `+${points}`;
            anim.style.left = (rect.left + rect.width / 2) + 'px';
            anim.style.top = (rect.top + window.scrollY) + 'px';
            document.body.appendChild(anim);
            
            setTimeout(() => anim.remove(), 1000);
        }
        
        function resetCourse() {
            if (confirm('M√∂chtest du wirklich alle Fortschritte zur√ºcksetzen?')) {
                state.points = 0;
                state.answers = {};
                state.errors = [];
                state.completedModules.clear();
                localStorage.removeItem(STORAGE_KEY);
                navigateTo('welcome');
            }
        }
        
        // ============ CALCULATOR FUNCTIONS ============
        
        // Safe math evaluation with support for ^ (power)
        function safeCalculateExpression(expression) {
            // Replace comma with dot for international input
            let expr = expression.replace(/,/g, '.');
            
            // Replace ^ with ** for JavaScript Math
            expr = expr.replace(/\^/g, '**');

            // Regex to check if expression contains only numbers, +, -, *, /, (), ., and ** (from ^)
            const safeExpression = /^[\d\s\+\-\*\/\.\(\)]+$/;
            
            // Safety check against malicious code injection
            if (!safeExpression.test(expr.replace(/\*\*/g, ''))) {
                throw new Error("Ung√ºltige Zeichen im Ausdruck.");
            }
            
            // Safely evaluate the expression
            return new Function('return ' + expr)();
        }

        function quickCalculate() {
            const input = document.getElementById('quickCalc');
            const resultSpan = document.getElementById('quickResult');
            const stepsDiv = document.getElementById('quickSteps');
            
            try {
                const result = safeCalculateExpression(input.value);
                
                // Formatierung: gro√üe Zahlen ohne unn√∂tige Dezimalstellen
                let formattedResult;
                if (Number.isInteger(result) || Math.abs(result) >= 1000) {
                    formattedResult = Math.round(result).toLocaleString('de-DE', { maximumFractionDigits: 0 });
                } else {
                    formattedResult = result.toFixed(4).replace(/\.?0+$/, '').toLocaleString('de-DE');
                }
                
                resultSpan.textContent = `= ${formattedResult}`;
                
                stepsDiv.classList.add('show');
                stepsDiv.innerHTML = `
                    <div class="calc-step">Eingabe: ${input.value}</div>
                    <div class="calc-result">Ergebnis: ${formattedResult}</div>
                `;
            } catch (e) {
                resultSpan.textContent = '= Fehler!';
                stepsDiv.classList.add('show');
                stepsDiv.innerHTML = `<div class="calc-step" style="color: var(--danger);">Fehler: Ung√ºltiger Ausdruck oder ung√ºltige Zeichen.</div>`;
            }
        }
        
        function initSimulators() {
            // Simulator 1: Scaling
            const sim1Width = document.getElementById('sim1Width');
            const sim1Ppi = document.getElementById('sim1Ppi');
            const sim1NewWidth = document.getElementById('sim1NewWidth');
            const sim1UnitSelect = document.getElementById('sim1Unit');

            const updateSim1 = () => {
                const unitType = sim1UnitSelect.value;
                const width = parseFloat(sim1Width.value);
                const resolution = parseFloat(sim1Ppi.value);
                const newWidth = parseFloat(sim1NewWidth.value);
                
                let pixels;
                let newResolution;
                let unitLabel;
                let conversionFactor = unitType === 'cm_ppi' ? 2.54 : 1;
                
                if (unitType === 'cm_ppi') {
                    // Cms and ppi
                    pixels = Math.round(width * resolution / conversionFactor);
                    newResolution = pixels * conversionFactor / newWidth;
                    unitLabel = 'ppi';
                } else {
                    // mm and px/cm (Scale everything to cm for easier calculation)
                    const width_cm = width / 10;
                    const newWidth_cm = newWidth / 10;
                    
                    pixels = Math.round(width_cm * resolution);
                    newResolution = pixels / newWidth_cm;
                    unitLabel = 'px/cm';
                }

                document.getElementById('sim1WidthVal').textContent = `${width} ${unitType === 'cm_ppi' ? 'cm' : 'mm'}`;
                document.getElementById('sim1PpiVal').textContent = `${resolution} ${unitLabel}`;
                document.getElementById('sim1NewWidthVal').textContent = `${newWidth} ${unitType === 'cm_ppi' ? 'cm' : 'mm'}`;
                
                document.getElementById('sim1Pixels').textContent = pixels.toLocaleString('de-DE');
                document.getElementById('sim1NewPpi').textContent = newResolution.toFixed(2).replace(/\.?0+$/, '');
                document.getElementById('sim1NewPpiLabel').textContent = `Neue ${unitLabel}`;
            };

            window.updateSim1Units = () => {
                const unitType = sim1UnitSelect.value;
                if (unitType === 'mm_pxcm') {
                    sim1Width.max = 500; sim1Width.value = 200;
                    sim1NewWidth.max = 500; sim1NewWidth.value = 250;
                    sim1Ppi.min = 50; sim1Ppi.max = 250; sim1Ppi.value = 100; sim1Ppi.step = 5;
                    document.getElementById('sim1WidthLabel').textContent = 'Urspr. Breite (mm):';
                    document.getElementById('sim1PpiLabel').textContent = 'Urspr. px/cm:';
                    document.getElementById('sim1NewWidthLabel').textContent = 'Neue Breite (mm):';
                } else {
                    sim1Width.max = 50; sim1Width.value = 20;
                    sim1NewWidth.max = 50; sim1NewWidth.value = 25;
                    sim1Ppi.min = 72; sim1Ppi.max = 600; sim1Ppi.value = 300; sim1Ppi.step = 1;
                    document.getElementById('sim1WidthLabel').textContent = 'Urspr. Breite (cm):';
                    document.getElementById('sim1PpiLabel').textContent = 'Urspr. ppi:';
                    document.getElementById('sim1NewWidthLabel').textContent = 'Neue Breite (cm):';
                }
                updateSim1();
            };
            
            if (sim1Width) {
                sim1Width.addEventListener('input', updateSim1);
                sim1Ppi.addEventListener('input', updateSim1);
                sim1NewWidth.addEventListener('input', updateSim1);
                sim1UnitSelect.addEventListener('change', updateSim1Units);
                updateSim1Units();
            }
            
            // Simulator 2: Storage
            const sim2Width = document.getElementById('sim2Width');
            const sim2Height = document.getElementById('sim2Height');
            const sim2Depth = document.getElementById('sim2Depth');
            
            if (sim2Width) {
                const updateSim2 = () => {
                    const width = parseInt(sim2Width.value);
                    const height = parseInt(sim2Height.value);
                    const depth = parseInt(sim2Depth.value);
                    
                    document.getElementById('sim2WidthVal').textContent = `${width} px`;
                    document.getElementById('sim2HeightVal').textContent = `${height} px`;
                    
                    const pixels = width * height;
                    const megapixels = (pixels / 1000000).toFixed(2);
                    const bytes = (pixels * depth) / 8;
                    const mb = (bytes / 1000000);
                    const mib = (bytes / 1048576);
                    
                    document.getElementById('sim2Megapixel').textContent = megapixels;
                    document.getElementById('sim2MB').textContent = mb.toFixed(2);
                    document.getElementById('sim2MiB').textContent = mib.toFixed(2);
                };
                
                sim2Width.addEventListener('input', updateSim2);
                sim2Height.addEventListener('input', updateSim2);
                sim2Depth.addEventListener('change', updateSim2);
                updateSim2();
            }
            
            // Simulator 3: Audio
            const sim3SampleRate = document.getElementById('sim3SampleRate');
            const sim3BitDepth = document.getElementById('sim3BitDepth');
            const sim3Channels = document.getElementById('sim3Channels');
            const sim3Duration = document.getElementById('sim3Duration');
            const sim3Steps = document.getElementById('sim3Steps');
            
            if (sim3SampleRate) {
                const updateSim3 = () => {
                    const sampleRate = parseInt(sim3SampleRate.value);
                    const bitDepth = parseInt(sim3BitDepth.value);
                    const channels = parseInt(sim3Channels.value);
                    const duration = parseInt(sim3Duration.value);
                    
                    const minutes = Math.floor(duration / 60);
                    const seconds = duration % 60;
                    document.getElementById('sim3DurationVal').textContent = `${minutes}:${seconds.toString().padStart(2, '0')} min`;
                    
                    const bitrateKbps = (sampleRate * bitDepth * channels) / 1000;
                    const totalBits = sampleRate * bitDepth * channels * duration;
                    const mb = totalBits / 8 / 1000000;
                    const mib = totalBits / 8 / 1048576;
                    
                    document.getElementById('sim3Bitrate').textContent = bitrateKbps.toFixed(0);
                    document.getElementById('sim3MB').textContent = mb.toFixed(2);
                    document.getElementById('sim3MiB').textContent = mib.toFixed(2);

                    // NEW: Quantization Steps
                    sim3Steps.textContent = Math.pow(2, bitDepth).toLocaleString('de-DE');
                };
                
                sim3SampleRate.addEventListener('change', updateSim3);
                sim3BitDepth.addEventListener('change', updateSim3);
                sim3Channels.addEventListener('change', updateSim3);
                sim3Duration.addEventListener('input', updateSim3);
                updateSim3();
            }
            
            // Initialize calculator
            updateCalculator();
        }
        
        function updateCalculator() {
            const type = document.getElementById('calcType').value;
            const inputsDiv = document.getElementById('calcInputs');
            
            const configs = {
                scaling: {
                    fields: [
                        { id: 'oldSize', label: 'Alte Gr√∂√üe', unit: 'cm', default: 20 },
                        { id: 'oldPpi', label: 'Alte Aufl√∂sung', unit: 'ppi', default: 300 },
                        { id: 'newSize', label: 'Neue Gr√∂√üe', unit: 'cm', default: 25 }
                    ]
                },
                storage: {
                    fields: [
                        { id: 'width', label: 'Breite', unit: 'px', default: 1920 },
                        { id: 'height', label: 'H√∂he', unit: 'px', default: 1080 },
                        { id: 'depth', label: 'Farbtiefe', unit: 'Bit', default: 24 }
                    ]
                },
                pixels: {
                    fields: [
                        { id: 'size', label: 'Gr√∂√üe', unit: 'cm', default: 10 },
                        { id: 'ppi', label: 'Aufl√∂sung', unit: 'ppi', default: 300 }
                    ]
                },
                audio: {
                    fields: [
                        { id: 'sampleRate', label: 'Abtastrate', unit: 'Hz', default: 44100 },
                        { id: 'bitDepth', label: 'Bittiefe', unit: 'Bit', default: 16 },
                        { id: 'channels', label: 'Kan√§le', unit: '', default: 2 },
                        { id: 'duration', label: 'Dauer', unit: 's', default: 180 }
                    ]
                },
                convert: {
                    fields: [
                        { id: 'value', label: 'Wert', unit: '', default: 100 },
                        { id: 'from', label: 'Von', unit: 'px/cm', default: 0, isSelect: true, options: ['px/cm ‚Üí ppi', 'ppi ‚Üí px/cm', 'kB ‚Üí KiB', 'MB ‚Üí MiB', 'Hz ‚Üí kHz', 'kHz ‚Üí Hz'] }
                    ]
                }
            };
            
            const config = configs[type];
            inputsDiv.innerHTML = config.fields.map(f => {
                if (f.isSelect) {
                    return `
                        <div class="calc-row">
                            <span class="calc-label">${f.label}:</span>
                            <select id="calc_${f.id}" class="calc-input" style="width: 180px;">
                                ${f.options.map(o => `<option value="${o}">${o}</option>`).join('')}
                            </select>
                        </div>
                    `;
                }
                return `
                    <div class="calc-row">
                        <span class="calc-label">${f.label}:</span>
                        <input type="text" step="any" class="calc-input" id="calc_${f.id}" value="${f.default}" oninput="this.value = this.value.replace(',', '.')">
                        <span class="answer-unit">${f.unit}</span>
                    </div>
                `;
            }).join('');
            
            document.getElementById('calcSteps').classList.remove('show');
        }
        
        function calculate() {
            const type = document.getElementById('calcType').value;
            const stepsDiv = document.getElementById('calcSteps');
            let steps = [];
            let result = '';
            
            const getValue = (id) => parseFloat(document.getElementById(`calc_${id}`).value.replace(',', '.'));
            
            try {
                if (type === 'scaling') {
                    const oldSize = getValue('oldSize');
                    const oldPpi = getValue('oldPpi');
                    const newSize = getValue('newSize');
                    
                    const pixels = Math.round(oldSize * oldPpi / 2.54);
                    const newPpi = pixels * 2.54 / newSize;
                    
                    steps = [
                        `Schritt 1: Pixelanzahl berechnen (konstant)`,
                        `Pixel = ${oldSize} cm √ó ${oldPpi} ppi / 2,54 = ${pixels.toLocaleString('de-DE', { maximumFractionDigits: 0 })} px`,
                        `Schritt 2: Neue Aufl√∂sung berechnen`,
                        `Neue ppi = ${pixels.toLocaleString('de-DE', { maximumFractionDigits: 0 })} px √ó 2,54 / ${newSize} cm = ${newPpi.toFixed(2).toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ppi`,
                        `Oder direkt: ${oldPpi} √ó (${oldSize}/${newSize}) = ${newPpi.toFixed(2).toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ppi`
                    ];
                    result = newPpi.toFixed(2).toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ppi';
                }
                else if (type === 'storage') {
                    const width = getValue('width');
                    const height = getValue('height');
                    const depth = getValue('depth');
                    
                    const pixels = width * height;
                    const bits = pixels * depth;
                    const bytes = bits / 8;
                    const kb = bytes / 1000;
                    const kib = bytes / 1024;
                    const mb = bytes / 1000000;
                    const mib = bytes / 1048576;
                    
                    steps = [
                        `Schritt 1: Pixelanzahl`,
                        `${width.toLocaleString('de-DE', { maximumFractionDigits: 0 })} √ó ${height.toLocaleString('de-DE', { maximumFractionDigits: 0 })} = ${pixels.toLocaleString('de-DE', { maximumFractionDigits: 0 })} Pixel`,
                        `Schritt 2: Datenmenge in Bit`,
                        `${pixels.toLocaleString('de-DE', { maximumFractionDigits: 0 })} √ó ${depth} Bit = ${bits.toLocaleString('de-DE', { maximumFractionDigits: 0 })} Bit`,
                        `Schritt 3: Umrechnung in Byte`,
                        `${bits.toLocaleString('de-DE', { maximumFractionDigits: 0 })} / 8 = ${bytes.toLocaleString('de-DE', { maximumFractionDigits: 0 })} Byte`,
                        `Schritt 4: Verschiedene Einheiten (gerundet)`,
                        `${kb.toFixed(2).toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} kB | ${kib.toFixed(2).toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} KiB`,
                        `${mb.toFixed(2).toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} MB | ${mib.toFixed(2).toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} MiB`
                    ];
                    result = `${mb.toFixed(2).toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} MB / ${mib.toFixed(2).toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} MiB`;
                }
                else if (type === 'pixels') {
                    const size = getValue('size');
                    const ppi = getValue('ppi');
                    
                    const pixels = size * ppi / 2.54;
                    
                    steps = [
                        `Formel: Pixel = Gr√∂√üe (cm) √ó Aufl√∂sung (ppi) / 2,54`,
                        `Pixel = ${size} cm √ó ${ppi} ppi / 2,54`,
                        `Pixel = ${pixels.toFixed(2).toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`
                    ];
                    result = Math.round(pixels).toLocaleString('de-DE') + ' Pixel';
                }
                else if (type === 'audio') {
                    const sampleRate = getValue('sampleRate');
                    const bitDepth = getValue('bitDepth');
                    const channels = getValue('channels');
                    const duration = getValue('duration');
                    
                    const totalSamples = sampleRate * duration;
                    const totalBits = totalSamples * bitDepth * channels;
                    const bytes = totalBits / 8;
                    const kb = bytes / 1000;
                    const mb = bytes / 1000000;
                    const mib = bytes / 1048576;
                    const bitrateKbps = (sampleRate * bitDepth * channels) / 1000;
                    
                    steps = [
                        `Schritt 1: Samples gesamt`,
                        `${sampleRate.toLocaleString('de-DE', { maximumFractionDigits: 0 })} Hz √ó ${duration} s = ${totalSamples.toLocaleString('de-DE', { maximumFractionDigits: 0 })} Samples`,
                        `Schritt 2: Datenmenge in Bit`,
                        `${totalSamples.toLocaleString('de-DE', { maximumFractionDigits: 0 })} √ó ${bitDepth} Bit √ó ${channels} Kan√§le = ${totalBits.toLocaleString('de-DE', { maximumFractionDigits: 0 })} Bit`,
                        `Schritt 3: Umrechnung in Byte`,
                        `${totalBits.toLocaleString('de-DE', { maximumFractionDigits: 0 })} / 8 = ${bytes.toLocaleString('de-DE', { maximumFractionDigits: 0 })} Byte`,
                        `Schritt 4: Ergebnisse (gerundet)`,
                        `Bitrate: ${bitrateKbps.toFixed(0).toLocaleString('de-DE', { maximumFractionDigits: 0 })} kBit/s`,
                        `${mb.toFixed(2).toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} MB | ${mib.toFixed(2).toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} MiB`
                    ];
                    result = `${mb.toFixed(2).toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} MB / ${mib.toFixed(2).toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} MiB`;
                }
                else if (type === 'convert') {
                    const value = getValue('value');
                    const conversion = document.getElementById('calc_from').value;
                    
                    let converted;
                    if (conversion === 'px/cm ‚Üí ppi') {
                        converted = value * 2.54;
                        steps = [`${value.toLocaleString('de-DE')} px/cm √ó 2,54 = ${converted.toFixed(2).toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ppi`];
                        result = converted.toFixed(2).toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ppi';
                    } else if (conversion === 'ppi ‚Üí px/cm') {
                        converted = value / 2.54;
                        steps = [`${value.toLocaleString('de-DE')} ppi / 2,54 = ${converted.toFixed(2).toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} px/cm`];
                        result = converted.toFixed(2).toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' px/cm';
                    } else if (conversion === 'kB ‚Üí KiB') {
                        const bytes = value * 1000;
                        converted = bytes / 1024;
                        steps = [`${value.toLocaleString('de-DE')} kB = ${bytes.toLocaleString('de-DE', { maximumFractionDigits: 0 })} Byte`, `${bytes.toLocaleString('de-DE', { maximumFractionDigits: 0 })} Byte / 1024 = ${converted.toFixed(4).toLocaleString('de-DE', { minimumFractionDigits: 4, maximumFractionDigits: 4 })} KiB`];
                        result = converted.toFixed(4).toLocaleString('de-DE', { minimumFractionDigits: 4, maximumFractionDigits: 4 }) + ' KiB';
                    } else if (conversion === 'MB ‚Üí MiB') {
                        const bytes = value * 1000000;
                        converted = bytes / 1048576;
                        steps = [`${value.toLocaleString('de-DE')} MB = ${bytes.toLocaleString('de-DE', { maximumFractionDigits: 0 })} Byte`, `${bytes.toLocaleString('de-DE', { maximumFractionDigits: 0 })} Byte / 1.048.576 = ${converted.toFixed(4).toLocaleString('de-DE', { minimumFractionDigits: 4, maximumFractionDigits: 4 })} MiB`];
                        result = converted.toFixed(4).toLocaleString('de-DE', { minimumFractionDigits: 4, maximumFractionDigits: 4 }) + ' MiB';
                    } else if (conversion === 'Hz ‚Üí kHz') {
                        converted = value / 1000;
                        steps = [`${value.toLocaleString('de-DE', { maximumFractionDigits: 0 })} Hz / 1.000 = ${converted.toFixed(3).toLocaleString('de-DE', { minimumFractionDigits: 3, maximumFractionDigits: 3 })} kHz`];
                        result = converted.toFixed(3).toLocaleString('de-DE', { minimumFractionDigits: 3, maximumFractionDigits: 3 }) + ' kHz';
                    } else if (conversion === 'kHz ‚Üí Hz') {
                        converted = value * 1000;
                        steps = [`${value.toLocaleString('de-DE')} kHz √ó 1.000 = ${converted.toLocaleString('de-DE', { maximumFractionDigits: 0 })} Hz`];
                        result = converted.toLocaleString('de-DE', { maximumFractionDigits: 0 }) + ' Hz';
                    }
                }
                
                stepsDiv.classList.add('show');
                stepsDiv.innerHTML = steps.map(s => `<div class="calc-step">${s}</div>`).join('') +
                    `<div class="calc-result">Ergebnis: ${result}</div>`;

            } catch (e) {
                stepsDiv.classList.add('show');
                stepsDiv.innerHTML = `<div class="calc-step" style="color: var(--danger);">Fehler: Ung√ºltiger Wert oder Rechenfehler.</div>`;
            }
        }
        
        // ============ RENDER ============
        function render() {
            renderSidebar();
            renderProgress();
            renderContent();
        }

        // ============ MOBILE FUNCTIONS ============
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('active');
        }
        
        // ============ FIXED CALCULATOR TOGGLE ============
        function toggleFixedCalc() {
            const calc = document.getElementById('fixedCalc');
            const toggleText = document.getElementById('calcToggleText');
            calc.classList.toggle('collapsed');
            if (calc.classList.contains('collapsed')) {
                toggleText.textContent = '‚ñ≤ Details';
            } else {
                toggleText.textContent = '‚ñº Details';
            }
        }
        
        function showFixedCalc(show) {
            const calc = document.getElementById('fixedCalc');
            const content = document.getElementById('content');
            if (show) {
                calc.classList.add('show');
                content.style.paddingTop = '100px';
                document.getElementById('sidebarSpacer').style.display = window.innerWidth > 900 ? 'block' : 'none';
            } else {
                calc.classList.remove('show');
                content.style.paddingTop = '30px';
                document.getElementById('sidebarSpacer').style.display = 'block';
            }
        }
        
        // ============ PDF GENERATION ============
        // [Existing PDF code remains the same, using jspdf library]
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            const pageWidth = doc.internal.pageSize.getWidth();
            const centerX = pageWidth / 2;
            const margin = 20;
            let y = 20;
            
            // Collect data
            const allExercises = [...exercises.A, ...exercises.B, ...exercises.C, ...exercises.D];
            const totalExercises = allExercises.length;
            const correctCount = Object.values(state.answers).filter(a => a.correct).length;
            const percentage = Math.round((correctCount / totalExercises) * 100);
            
            // Header
            doc.setFillColor(99, 102, 241);
            doc.rect(0, 0, pageWidth, 35, 'F');
            
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(20);
            doc.setTextColor(255, 255, 255);
            doc.text('Digitalisierung Bild & Audio', centerX, 15, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text('GINF Lernkurs - Ergebnisbericht', centerX, 25, { align: 'center' });
            
            y = 45;
            
            // Student Info
            doc.setTextColor(30, 30, 30);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(14);
            doc.text('Sch√ºler/in: ' + state.studentName, margin, y);
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text('Datum: ' + new Date().toLocaleDateString('de-AT', { day: '2-digit', month: 'long', year: 'numeric' }), pageWidth - margin, y, { align: 'right' });
            
            y += 15;
            
            // Results Box
            doc.setFillColor(248, 250, 252);
            doc.roundedRect(margin, y, pageWidth - 2*margin, 35, 3, 3, 'F');
            doc.setDrawColor(99, 102, 241);
            doc.setLineWidth(0.5);
            doc.roundedRect(margin, y, pageWidth - 2*margin, 35, 3, 3, 'S');
            
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.setTextColor(99, 102, 241);
            doc.text('ERGEBNIS', centerX, y + 8, { align: 'center' });
            
            // Score display
            const scoreColor = percentage >= 80 ? [22, 163, 74] : percentage >= 50 ? [245, 158, 11] : [239, 68, 68];
            doc.setFontSize(28);
            doc.setTextColor(...scoreColor);
            doc.text(percentage + '%', centerX, y + 25, { align: 'center' });
            
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text(state.points + ' von ' + state.maxPoints + ' Punkten | ' + correctCount + ' von ' + totalExercises + ' Aufgaben richtig', centerX, y + 32, { align: 'center' });
            
            y += 45;
            
            // Errors section
            const errorsList = [];
            for (const [key, value] of Object.entries(state.answers)) {
                if (!value.correct) {
                    const [group, id] = key.split('_');
                    const ex = exercises[group].find(e => String(e.id) === id);
                    if (ex) {
                        errorsList.push({
                            id: ex.id,
                            question: ex.question,
                            given: value.given,
                            correct: ex.answer,
                            unit: ex.unit
                        });
                    }
                }
            }
            
            if (errorsList.length > 0) {
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(12);
                doc.setTextColor(239, 68, 68);
                doc.text('Aufgaben mit Fehlern (' + errorsList.length + '):', margin, y);
                y += 8;
                
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(9);
                doc.setTextColor(60, 60, 60);
                
                errorsList.forEach((err, index) => {
                    if (y > 270) {
                        doc.addPage();
                        y = 20;
                    }
                    
                    // Question (truncated if too long)
                    let questionText = 'Aufgabe ' + err.id + ': ' + err.question;
                    if (questionText.length > 100) {
                        questionText = questionText.substring(0, 97) + '...';
                    }
                    
                    const lines = doc.splitTextToSize(questionText, pageWidth - 2*margin);
                    doc.text(lines, margin, y);
                    y += lines.length * 4 + 2;
                    
                    doc.setTextColor(239, 68, 68);
                    doc.text('Deine Antwort: ' + err.given.toLocaleString('de-DE') + ' ' + err.unit, margin + 5, y);
                    doc.setTextColor(22, 163, 74);
                    doc.text('Richtig: ' + err.correct + ' ' + err.unit, margin + 70, y);
                    doc.setTextColor(60, 60, 60);
                    
                    y += 8;
                });
            } else {
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(14);
                doc.setTextColor(22, 163, 74);
                doc.text('Alle Aufgaben richtig gel√∂st!', centerX, y, { align: 'center' });
            }
            
            // Footer
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text('BPI M√∂dling - GINF Lernkurs', centerX, 290, { align: 'center' });
            
            // Save
            doc.save('Ergebnis_' + state.studentName.replace(/\s+/g, '_') + '_Bildaufloesung.pdf');
        }
        
        // ============ EMAIL FUNCTION ============
        // [Existing Email code remains the same]
        function sendEmail() {
            const allExercises = [...exercises.A, ...exercises.B, ...exercises.C, ...exercises.D];
            const totalExercises = allExercises.length;
            const correctCount = Object.values(state.answers).filter(a => a.correct).length;
            const percentage = Math.round((correctCount / totalExercises) * 100);
            
            // Collect errors
            const errorsList = [];
            for (const [key, value] of Object.entries(state.answers)) {
                if (!value.correct) {
                    const [group, id] = key.split('_');
                    const ex = exercises[group].find(e => String(e.id) === id);
                    if (ex) {
                        errorsList.push(`Aufgabe ${ex.id}: ${value.given.toLocaleString('de-DE')} ${ex.unit} (richtig: ${ex.correct} ${ex.unit})`);
                    }
                }
            }
            
            const subject = encodeURIComponent(`GINF Ergebnis: Digitalisierung Bild & Audio - ${state.studentName}`);
            const body = encodeURIComponent(
`Sehr geehrte Damen und Herren,

hiermit √ºbermittle ich meine Ergebnisse f√ºr den Lernkurs "Digitalisierung Bild & Audio".

==============================
ERGEBNIS√úBERSICHT
==============================

Name: ${state.studentName}
Datum: ${new Date().toLocaleDateString('de-AT')}

Gesamtergebnis: ${percentage}%
Punkte: ${state.points} von ${state.maxPoints}
Aufgaben richtig: ${correctCount} von ${totalExercises}

${errorsList.length > 0 ? `
------------------------------
Aufgaben mit Fehlern (${errorsList.length}):
------------------------------
${errorsList.join('\n')}
` : 'Alle Aufgaben wurden richtig gel√∂st!'}

==============================

Mit freundlichen Gr√º√üen
${state.studentName}`
            );
            
            // E-Mail-Adresse hier anpassen
            const emailAddress = 'modic@akademie.bpi.ac.at';
            window.open(`mailto:${emailAddress}?subject=${subject}&body=${body}`, '_blank');
            
            alert('Das E-Mail-Programm wird ge√∂ffnet.\n\nBitte f√ºge das PDF als Anhang hinzu, falls du es bereits heruntergeladen hast.');
        }
        
        // ============ INIT ============
        loadState();
        render();

        // Workaround f√ºr Sidebar-Spacer (Desktop-Layout)
        window.addEventListener('resize', () => {
            const spacer = document.getElementById('sidebarSpacer');
            const showCalc = modules.find(m => m.id === state.currentModule)?.type === 'exercises' || modules.find(m => m.id === state.currentModule)?.type === 'simulation';
            if (spacer) {
                // Nur anzeigen, wenn Desktop und keine Exercises (Exercise Pages passen sich an)
                if (window.innerWidth > 900 && !showCalc) {
                    spacer.style.display = 'block';
                } else {
                    spacer.style.display = 'none';
                }
            }
        });
        
    </script>
</body>
</html>